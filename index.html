<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Organizador de BMs ‚Äî Online + Programa√ß√£o</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e7eefc;
      --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:12px;
      --accent:#4f9cff;
      --good:#35d07f;
      --mid:#f7c948;
      --bad:#ff5b5b;
      --chip:#1a2a49;
      --focus:0 0 0 3px rgba(79,156,255,.25);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 15% 10%, rgba(79,156,255,.16), transparent 60%),
                  radial-gradient(900px 700px at 85% 20%, rgba(53,208,127,.10), transparent 55%),
                  radial-gradient(900px 700px at 75% 90%, rgba(247,201,72,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    button, input, select, textarea{font:inherit;color:inherit}
    .app{max-width:1450px;margin:0 auto;padding:18px 16px 28px;}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 0; backdrop-filter: blur(8px); z-index: 5;
    }
    .brand{display:flex;gap:12px;align-items:center;min-width:260px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(79,156,255,.95), rgba(79,156,255,.25));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 25px rgba(79,156,255,.18);
    }
    .title{display:flex;flex-direction:column;line-height:1.15}
    .title b{font-size:15px;letter-spacing:.2px}
    .title span{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      padding:10px 10px; border-radius: 999px;
    }
    .pill input{border:0;outline:0;background:transparent;min-width:240px;}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:10px 12px;border-radius:999px;cursor:pointer;transition:.15s ease;
      display:inline-flex;gap:8px;align-items:center;white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.08)}
    .btn:active{transform:translateY(0px)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .btn.primary{
      background: linear-gradient(135deg, rgba(79,156,255,.92), rgba(79,156,255,.35));
      border:1px solid rgba(79,156,255,.55);
      box-shadow: 0 10px 24px rgba(79,156,255,.18);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,91,91,.9), rgba(255,91,91,.25));
      border:1px solid rgba(255,91,91,.55);
      box-shadow: 0 10px 24px rgba(255,91,91,.14);
    }
    .btn.ghost{background:transparent;}
    .tabs{
      display:flex;gap:8px;align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      padding:6px;border-radius:999px;
    }
    .tab{border:0;background:transparent;padding:9px 12px;border-radius:999px;cursor:pointer;color:var(--muted)}
    .tab.active{background: rgba(255,255,255,.08);color: var(--text);border:1px solid rgba(255,255,255,.10)}
    .statuspill{
      display:flex;gap:8px;align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.25);}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.mid{background:var(--mid)}
    .content{margin-top:14px;}
    .board{display:flex;gap:12px;overflow-x:auto;padding-bottom:10px;}
    .col{
      min-width:320px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .col-header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:6px 4px 10px;
      border-bottom:1px dashed rgba(255,255,255,.10);
      margin-bottom:10px;
    }
    .col-header b{font-size:13px}
    .badge{
      font-size:12px;padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
    }
    .dropzone{min-height:60px;display:flex;flex-direction:column;gap:10px;padding:2px;border-radius: var(--radius2);}
    .dropzone.dragover{
      outline: 2px dashed rgba(79,156,255,.55);
      outline-offset: 4px;
      background: rgba(79,156,255,.06);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
      padding:10px;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      cursor: grab;
    }
    .card.readonly{cursor: default;}
    .card:active{cursor: grabbing}
    .card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px;}
    .bm-id{
      font-family: var(--mono);font-size: 12px;letter-spacing: .2px;
      background: rgba(26,42,73,.7);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 8px;border-radius:10px;
      display:inline-flex;gap:8px;align-items:center;
      max-width: 230px;overflow:hidden;text-overflow: ellipsis;white-space: nowrap;
    }
    .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px;}
    .chip{
      font-size:12px;padding:6px 8px;border-radius:999px;
      background: rgba(26,42,73,.55);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      display:inline-flex;gap:6px;align-items:center;
    }
    .chip strong{color:var(--text);font-weight:600}
    .qdot{width:8px;height:8px;border-radius:999px;display:inline-block;}
    .qdot.good{background:var(--good)}
    .qdot.mid{background:var(--mid)}
    .qdot.bad{background:var(--bad)}
    .small{font-size: 12px;color: var(--muted);line-height: 1.35;}
    .actions{display:flex;gap:8px;align-items:center;}
    .iconbtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      width:36px;height:36px;border-radius: 12px;cursor:pointer;
      display:grid;place-items:center;transition:.15s ease;flex: 0 0 auto;
    }
    .iconbtn:hover{background: rgba(255,255,255,.08); transform: translateY(-1px)}
    .iconbtn:active{transform: translateY(0px)}
    .iconbtn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .warn{color: rgba(255,91,91,.92);font-weight: 600;}
    .agenda{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 980px){
      .agenda{grid-template-columns: 1fr;}
      .pill input{min-width:160px}
      .brand{min-width: 0}
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .panel h3{margin: 6px 0 10px;font-size: 14px;letter-spacing: .2px;}
    .list{display:flex;flex-direction:column;gap:10px;}
    .row{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px;border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);background: rgba(255,255,255,.03);
    }
    .row-left{display:flex;flex-direction:column;gap:6px;min-width: 0}
    .row-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .kbd{
      font-family: var(--mono);
      font-size: 12px;color: var(--muted);
      padding: 4px 8px;border-radius: 10px;
      border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.04);
    }

    /* Programa√ß√£o */
    .prog-grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:12px;}
    @media (max-width: 980px){ .prog-grid{grid-template-columns:1fr;} }
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
    .toolbar-left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toolbar-right{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .field-inline{
      display:flex;gap:8px;align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;border-radius:999px;
      color: var(--muted);font-size:12px;
    }
    .field-inline input{
      border:0;outline:0;background:transparent;color:var(--text);
      font-size:12px;
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:middle;
      font-size:12px;
    }
    .table th{
      text-align:left;
      color: var(--muted);
      background: rgba(255,255,255,.03);
      position:sticky;
      top:0;
      z-index:1;
    }
    .table tr:last-child td{border-bottom:0}
    .cell-input{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 10px;
      padding:8px 8px;
      outline:none;
      font-size:12px;
    }
    .cell-input:focus{box-shadow: var(--focus); border-color: rgba(79,156,255,.55)}
    .mini{
      width: 90px;
    }
    .mini2{width: 110px;}
    .nowrap{white-space:nowrap}
    .trash{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 10px;
      width:36px;height:36px;
      cursor:pointer;
    }
    .trash:hover{background: rgba(255,255,255,.08)}
    pre.output{
      margin:0;
      padding:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.5;
      min-height: 420px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Modals */
    .modal-backdrop{
      position:fixed; inset:0;background: rgba(0,0,0,.55);
      display:none; place-items:center; z-index: 10; padding: 14px;
    }
    .modal-backdrop.open{display:grid}
    .modal{
      width:min(980px, 100%);
      background: linear-gradient(180deg, rgba(16,31,54,.98), rgba(15,26,46,.98));
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 28px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal.sm{width:min(720px, 100%);}
    .modal-header{
      padding:14px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.03);
    }
    .modal-header b{font-size:14px}
    .modal-body{
      padding:14px;display:grid;grid-template-columns: 1.15fr .85fr;gap:12px;
    }
    .modal-body.one{grid-template-columns:1fr;}
    @media (max-width: 920px){ .modal-body{grid-template-columns: 1fr;} }
    .field{
      display:flex;flex-direction:column;gap:6px;
      padding:10px;border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;background: rgba(255,255,255,.03);
    }
    .field label{font-size:12px; color: var(--muted)}
    .field input,.field select,.field textarea{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      padding:10px 10px;
      outline: none;
    }
    .field input:focus,.field select:focus,.field textarea:focus{box-shadow: var(--focus); border-color: rgba(79,156,255,.55)}
    textarea{min-height:140px; resize: vertical}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 520px){ .grid2{grid-template-columns:1fr} }
    .modal-footer{
      padding:14px;display:flex;justify-content:space-between;gap:10px;
      border-top:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.02);
      flex-wrap:wrap;
    }
    .hint{font-size:12px; color: var(--muted)}
    .hr{height:1px; background: rgba(255,255,255,.08); margin: 10px 0}
    .toast{
      position:fixed;right:16px;bottom:16px;
      background: rgba(20,34,60,.92);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding:10px 12px;border-radius: 14px;
      box-shadow: var(--shadow);
      display:none;max-width: 560px;z-index: 20;
    }
    .toast.show{display:block}
    .mono{font-family: var(--mono)}
    .muted{color: var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>Organizador de BMs</b>
          <span>Leitura x Edi√ß√£o + Programa√ß√£o de Disparos (texto padr√£o)</span>
        </div>
      </div>

      <div class="controls">
        <div class="tabs" role="tablist" aria-label="Modo">
          <button class="tab active" id="tabBoard" role="tab" aria-selected="true">Board</button>
          <button class="tab" id="tabAgenda" role="tab" aria-selected="false">Agenda</button>
          <button class="tab" id="tabProg" role="tab" aria-selected="false">Programa√ß√£o</button>
        </div>

        <div class="statuspill" title="Status de sincroniza√ß√£o">
          <span class="dot" id="syncDot"></span>
          <span id="syncText">Local: edit√°vel</span>
        </div>

        <button class="btn" id="btnSettings">‚öôÔ∏è Online</button>

        <div class="pill" title="Buscar por BM, observa√ß√£o ou n√∫mero">
          <span style="opacity:.85">üîé</span>
          <input id="search" placeholder="Buscar (ex: 5768, 'cart√£o', 'template'...)" />
        </div>

        <select id="filterQuality" class="btn" title="Filtrar por qualidade">
          <option value="">Qualidade: Todas</option>
          <option value="APROVADO">Aprovado</option>
          <option value="MEDIA">Qualidade m√©dia</option>
          <option value="BAIXA">Qualidade baixa (risco)</option>
        </select>

        <button class="btn primary" id="btnAdd">Ôºã Nova BM</button>
        <button class="btn" id="btnExport">Exportar</button>
        <button class="btn" id="btnImport">Importar</button>
        <input type="file" id="importFile" accept="application/json" style="display:none" />
        <button class="btn danger" id="btnReset" title="Apaga tudo deste navegador">Limpar</button>
      </div>
    </div>

    <div class="content">
      <!-- BOARD -->
      <div id="viewBoard">
        <div class="board" id="board"></div>
        <div class="panel" style="margin-top:12px">
          <h3>Modo Leitura x Modo Edi√ß√£o (como ativar)</h3>
          <div class="small">
            ‚Ä¢ Sem URL de API: <b>modo LOCAL</b> (edit√°vel).<br>
            ‚Ä¢ Com URL de API e <b>sem chave</b>: <b>somente leitura</b>.<br>
            ‚Ä¢ Com URL de API e <b>com chave</b>: <b>modo edi√ß√£o</b> (sincroniza).<br><br>
            <span class="kbd">Link de edi√ß√£o recomendado (n√£o vai pro servidor):</span>
            <div class="small" style="margin-top:6px">
              <span class="mono">.../index.html#api=URL_DA_API&key=SUA_CHAVE&editor=Planejamento</span>
            </div>
          </div>
        </div>
      </div>

      <!-- AGENDA -->
      <div id="viewAgenda" style="display:none">
        <div class="agenda">
          <div class="panel">
            <h3>Disparos agendados (por dia)</h3>
            <div class="small">Use ‚ÄúEditar‚Äù na BM para escolher <b>Data do disparo</b> ou <b>Dia da semana</b>.</div>
            <div class="hr"></div>
            <div id="agendaUpcoming" class="list"></div>
          </div>

          <div class="panel">
            <h3>Hist√≥rico</h3>
            <div class="small">BMs marcadas como <b>Disparado</b> aparecem aqui.</div>
            <div class="hr"></div>
            <div id="agendaDone" class="list"></div>
          </div>
        </div>
      </div>

      <!-- PROGRAMA√á√ÉO -->
      <div id="viewProg" style="display:none">
        <div class="prog-grid">
          <div class="panel">
            <div class="toolbar">
              <div class="toolbar-left">
                <div class="field-inline">
                  <span>üìÖ Data:</span>
                  <input id="progDate" type="date" />
                </div>
                <button class="btn" id="btnAddLine">Ôºã Linha</button>
                <button class="btn" id="btnImportText">Importar texto</button>
              </div>
              <div class="toolbar-right">
                <span class="kbd" id="progTotals">0 linhas ‚Ä¢ 0 disparos</span>
                <button class="btn primary" id="btnGenerate">Gerar texto</button>
                <button class="btn" id="btnCopy">Copiar</button>
              </div>
            </div>

            <div style="max-height:520px; overflow:auto; border-radius:14px;">
              <table class="table" aria-label="Tabela de programa√ß√£o">
                <thead>
                  <tr>
                    <th style="width:220px">Operador</th>
                    <th style="width:140px">4 d√≠gitos</th>
                    <th style="width:120px">Qtd</th>
                    <th style="width:140px">Hora</th>
                    <th style="width:90px" class="nowrap">A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="progBody"></tbody>
              </table>
            </div>

            <div class="small" style="margin-top:10px">
              Formato gerado (igual seu padr√£o):<br>
              <span class="mono">MARCOS</span><br>
              <span class="mono">5768 - 100 (09:30)</span>
            </div>
          </div>

          <div class="panel">
            <h3>Texto gerado</h3>
            <pre class="output" id="progOutput"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: BM -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <b id="modalTitle">BM</b>
        <button class="btn ghost" id="btnClose">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="field">
            <label>Identifica√ß√£o da BM (nome / apelido / ID)</label>
            <input id="fBmId" placeholder="Ex: GBR Joice 2000 | 7436 | BM AILTON" />
          </div>

          <div class="grid2">
            <div class="field">
              <label>Status (coluna)</label>
              <select id="fColumn"></select>
            </div>
            <div class="field">
              <label>Qualidade</label>
              <select id="fQuality">
                <option value="APROVADO">Aprovado</option>
                <option value="MEDIA">Qualidade m√©dia</option>
                <option value="BAIXA">Qualidade baixa (risco)</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>N√∫meros vinculados (at√© 10) ‚Äî um por linha</label>
            <textarea id="fNumbers" placeholder="Ex:
11999999999
11888888888
..."></textarea>
            <div class="hint">Contagem: <span id="numbersCount" class="mono">0/10</span></div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Disparo agendado (data)</label>
              <input id="fDisparoDate" type="date" />
            </div>
            <div class="field">
              <label>Disparo agendado (dia da semana)</label>
              <select id="fDisparoWeekday">
                <option value="">‚Äî</option>
                <option value="SEGUNDA">Segunda-feira</option>
                <option value="TERCA">Ter√ßa-feira</option>
                <option value="QUARTA">Quarta-feira</option>
                <option value="QUINTA">Quinta-feira</option>
                <option value="SEXTA">Sexta-feira</option>
                <option value="SABADO">S√°bado</option>
                <option value="DOMINGO">Domingo</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>Observa√ß√µes</label>
            <textarea id="fNotes" placeholder="Ex: aguardando cart√£o, template em an√°lise, risco, etc."></textarea>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="field">
            <label>Data de cria√ß√£o (fica fixa)</label>
            <input id="fCreatedAt" disabled />
          </div>

          <div class="field">
            <label>√öltima edi√ß√£o</label>
            <input id="fUpdatedAt" disabled />
          </div>

          <div class="field">
            <label>Marcar como ‚ÄúDisparado‚Äù</label>
            <div class="grid2">
              <label class="btn" style="justify-content:center; gap:10px; cursor:pointer;">
                <input type="checkbox" id="fIsDone" style="transform:scale(1.15); accent-color: var(--accent);" />
                <span>Disparado</span>
              </label>
              <input id="fDoneAt" type="date" />
            </div>
          </div>

          <div class="field">
            <label>Excluir BM</label>
            <button class="btn danger" id="btnDelete">Excluir</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="hint" id="editHint">Modo: Local</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnCancel">Cancelar</button>
          <button class="btn primary" id="btnSave">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Settings -->
  <div class="modal-backdrop" id="settingsBackdrop" aria-hidden="true">
    <div class="modal sm" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-header">
        <b id="settingsTitle">Configurar Online</b>
        <button class="btn ghost" id="btnSettingsClose">‚úï</button>
      </div>
      <div class="modal-body one">
        <div class="field">
          <label>URL da API (Google Apps Script / etc.)</label>
          <input id="sApiUrl" placeholder="Cole aqui a URL do Web App" />
          <div class="hint">Com URL preenchida: abre dados online. Sem URL: continua modo LOCAL.</div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Nome do editor (aparece na ‚Äú√öltima edi√ß√£o‚Äù)</label>
            <input id="sEditor" placeholder="Ex: Planejamento / Pedro / Roberto" />
          </div>
          <div class="field">
            <label>Chave de edi√ß√£o</label>
            <input id="sEditKey" placeholder="Sem chave = somente leitura no online" />
            <div class="hint">Quem tiver essa chave consegue editar o ONLINE; sem chave fica s√≥ visualiza√ß√£o.</div>
          </div>
        </div>

        <div class="field">
          <label>Teste de conex√£o</label>
          <button class="btn" id="btnPing">Testar API</button>
          <div class="hint" id="pingResult">‚Äî</div>
        </div>

        <div class="field">
          <label>Link pronto (edi√ß√£o)</label>
          <div class="small">
            Depois que o site estiver hospedado, use esse padr√£o:<br>
            <span class="mono">SEU_SITE/index.html#api=URL_DA_API&key=SUA_CHAVE&editor=Planejamento</span><br>
            (dica: usar <b>#</b> n√£o envia a chave para o servidor)
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="hint">Ap√≥s salvar, o sistema tenta conectar e sincronizar.</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn danger" id="btnClearSettings">Limpar Config</button>
          <button class="btn" id="btnSettingsCancel">Cancelar</button>
          <button class="btn primary" id="btnSettingsSave">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Import Programa√ß√£o -->
  <div class="modal-backdrop" id="importProgBackdrop" aria-hidden="true">
    <div class="modal sm" role="dialog" aria-modal="true" aria-labelledby="importProgTitle">
      <div class="modal-header">
        <b id="importProgTitle">Importar Programa√ß√£o (texto)</b>
        <button class="btn ghost" id="btnImportProgClose">‚úï</button>
      </div>
      <div class="modal-body one">
        <div class="field">
          <label>Cole o texto no formato atual (exatamente como voc√™ monta)</label>
          <textarea id="importProgText" placeholder="MARCOS

5768 - 100 (09:30)
9106 - 100 (10:00)

SPORT

4630 - 120 (09:30)
..."></textarea>
          <div class="hint">Vai criar linhas na data selecionada.</div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="hint">Dica: voc√™ pode importar v√°rias vezes; depois edita na tabela.</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnImportProgCancel">Cancelar</button>
          <button class="btn primary" id="btnImportProgRun">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Online contract:
    // GET  API_URL              -> { items: [...], dispatches: [...] }
    // POST API_URL?key=EDIT_KEY -> body { items: [...], dispatches: [...] }

    const CACHE_KEY = "bm_board_cache_v4";
    const SETTINGS_KEY = "bm_board_settings_v4";

    const COLUMNS = [
      { id:"standby",  name:"STAND BY" },
      { id:"numeros",  name:"N√öMEROS (at√© 10)" },
      { id:"cartao",   name:"CART√ÉO" },
      { id:"template", name:"TEMPLATE EM AN√ÅLISE" },
      { id:"disparos", name:"DISPAROS" }
    ];

    const QUALITY = {
      APROVADO: { label:"Aprovado", dot:"good" },
      MEDIA:    { label:"Qualidade m√©dia", dot:"mid" },
      BAIXA:    { label:"Qualidade baixa (risco)", dot:"bad" }
    };

    let settings = { apiUrl:"https://script.google.com/macros/s/AKfycbxyWYuCvc5P-LL3LzKOKiyJ6DeQEijd3R23fyIgQ-Q87wf4sylrF4z5sWhfJ6qYCfKH/exec", editKey:"", editorName:"" };
    let state = { items: [], dispatches: [] };

    let currentId = null;
    let dirty = false;
    let syncing = false;
    let lastRemoteSig = "";
    let syncTimer = null;
    let pollTimer = null;

    const $ = (sel) => document.querySelector(sel);

    const pad2 = (n) => String(n).padStart(2,"0");
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function nowISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    function toBR(isoDate){
      if(!isoDate) return "‚Äî";
      const [y,m,d] = isoDate.split("-");
      return `${d}/${m}/${y}`;
    }
    function uuid(){
      return (crypto?.randomUUID?.() || ("id-"+Math.random().toString(16).slice(2) + "-" + Date.now()));
    }
    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 2600);
    }
    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizeNumbers(text){
      const arr = (text || "")
        .split(/\r?\n/g)
        .map(s => s.trim())
        .filter(Boolean);
      const seen = new Set();
      const out = [];
      for(const n of arr){
        if(!seen.has(n)){
          seen.add(n);
          out.push(n);
        }
      }
      return out.slice(0, 10);
    }
    function getColumnName(id){
      return (COLUMNS.find(c=>c.id===id)?.name) || id;
    }
    function qualityChip(q){
      const qd = QUALITY[q] || QUALITY.MEDIA;
      const risk = (q === "BAIXA");
      return `
        <span class="chip" title="${qd.label}">
          <span class="qdot ${qd.dot}"></span>
          <span>${risk ? '<span class="warn">RISCO</span>' : qd.label}</span>
        </span>
      `;
    }
    function scheduleLabel(item){
      if(item.disparoDate) return `üìÖ ${toBR(item.disparoDate)}`;
      if(item.disparoWeekday){
        const map = {SEGUNDA:"Segunda",TERCA:"Ter√ßa",QUARTA:"Quarta",QUINTA:"Quinta",SEXTA:"Sexta",SABADO:"S√°bado",DOMINGO:"Domingo"};
        return `üóìÔ∏è ${map[item.disparoWeekday] || item.disparoWeekday}`;
      }
      return "‚Äî";
    }
    function matchesFilters(item){
      const q = ($("#filterQuality").value || "").trim();
      if(q && item.quality !== q) return false;

      const s = ($("#search").value || "").trim().toLowerCase();
      if(!s) return true;
      const hay = [
        item.bmId,
        item.notes || "",
        (item.numbers || []).join(" "),
        getColumnName(item.column),
        item.quality
      ].join(" ").toLowerCase();
      return hay.includes(s);
    }

    function hasOnline(){ return !!settings.apiUrl; }
    function canSync(){ return !!(settings.apiUrl && settings.editKey); }
    function canEdit(){
      if(!hasOnline()) return true;      // local edit always
      return !!settings.editKey;         // online edit needs key
    }

    function setSyncUI(mode){
      const dot = $("#syncDot");
      const text = $("#syncText");
      dot.className = "dot";
      if(mode === "local"){
        dot.classList.add("mid");
        text.textContent = "Local: edit√°vel";
      }else if(mode === "online_readonly"){
        dot.classList.add("good");
        text.textContent = "Online: leitura";
      }else if(mode === "online_edit"){
        dot.classList.add("good");
        text.textContent = dirty ? "Online: edi√ß√£o (pendente)" : "Online: edi√ß√£o";
      }else if(mode === "syncing"){
        dot.classList.add("mid");
        text.textContent = "Online: sincronizando‚Ä¶";
      }else if(mode === "offline_cache"){
        dot.classList.add("mid");
        text.textContent = "Online: cache";
      }else if(mode === "error"){
        dot.classList.add("bad");
        text.textContent = "Online: erro";
      }
    }

    function updateEditUI(){
      const editable = canEdit();
      $("#btnAdd").disabled = !editable;
      $("#btnImport").disabled = !editable;
      $("#btnReset").disabled = !editable;

      if(!hasOnline()){ setSyncUI("local"); return; }
      if(syncing){ setSyncUI("syncing"); return; }
      if(canSync()) setSyncUI("online_edit");
      else setSyncUI("online_readonly");
    }

    function saveCache(){ localStorage.setItem(CACHE_KEY, JSON.stringify(state)); }
    function loadCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && Array.isArray(parsed.items)) state.items = parsed.items;
          if(parsed && Array.isArray(parsed.dispatches)) state.dispatches = parsed.dispatches;
        }
      }catch(e){}
      if(!Array.isArray(state.items)) state.items = [];
      if(!Array.isArray(state.dispatches)) state.dispatches = [];
    }
    function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }
    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          settings = {
            apiUrl: (parsed.apiUrl || "").trim(),
            editKey: (parsed.editKey || "").trim(),
            editorName: (parsed.editorName || "").trim()
          };
        }
      }catch(e){}
    }

    function signatureOf(st){
      const str = JSON.stringify({
        items: (st.items||[]).map(i=>[
          i.id,i.bmId,i.column,i.quality,i.createdAt,i.updatedAt,
          i.disparoDate||"",i.disparoWeekday||"",i.isDone?1:0,i.doneAt||"",
          (i.numbers||[]).join(","),(i.notes||"")
        ]),
        dispatches: (st.dispatches||[]).map(d=>[d.id,d.date,d.operator,d.code,d.qty,d.time])
      });
      let h = 0;
      for(let k=0;k<str.length;k++) h = (h*31 + str.charCodeAt(k)) >>> 0;
      return String(h);
    }

    function parseUpdatedAt(ts){
      const base = String(ts || "").slice(0,16); // YYYY-MM-DD HH:MM
      const m = base.match(/^(\d{4})-(\d{2})-(\d{2})\s(\d{2}):(\d{2})$/);
      if(!m) return 0;
      return new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], 0).getTime();
    }

    function mergeItemsById(localItems, remoteItems){
      const map = new Map();
      for(const it of (remoteItems || [])) map.set(it.id, it);
      for(const it of (localItems || [])){
        if(!map.has(it.id)){
          map.set(it.id, it);
        }else{
          const r = map.get(it.id);
          map.set(it.id, parseUpdatedAt(it.updatedAt) >= parseUpdatedAt(r.updatedAt) ? it : r);
        }
      }
      return Array.from(map.values());
    }

    function mergeDispatches(localArr, remoteArr){
      const map = new Map();
      for(const d of (remoteArr||[])) map.set(d.id, d);
      for(const d of (localArr||[])) if(!map.has(d.id)) map.set(d.id, d);
      return Array.from(map.values());
    }

    async function fetchRemote(){
      const res = await fetch(settings.apiUrl, { method:"GET", cache:"no-store" });
      if(!res.ok) throw new Error("GET " + res.status);
      const data = await res.json();
      if(!data || !Array.isArray(data.items)) throw new Error("Formato inv√°lido (esperado {items:[]})");
      if(!Array.isArray(data.dispatches)) data.dispatches = [];
      return data;
    }

    async function pushRemote(){
      if(!canSync()) throw new Error("Sem chave de edi√ß√£o.");
      const url = settings.apiUrl + (settings.apiUrl.includes("?") ? "&" : "?") + "key=" + encodeURIComponent(settings.editKey);
      const res = await fetch(url, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(state)
      });
      if(!res.ok) throw new Error("POST " + res.status);
      try{ await res.json(); }catch(e){}
    }

    function scheduleSync(){
      if(!canSync()) return;
      dirty = true;
      updateEditUI();
      clearTimeout(syncTimer);
      syncTimer = setTimeout(async ()=>{
        try{
          syncing = true;
          setSyncUI("syncing");
          await pushRemote();
          dirty = false;
          syncing = false;
          lastRemoteSig = signatureOf(state);
          updateEditUI();
          toast("Sincronizado.");
        }catch(e){
          syncing = false;
          setSyncUI("error");
          updateEditUI();
          toast("Erro ao sincronizar. Confira ‚öôÔ∏è Online.");
          console.error(e);
        }
      }, 650);
    }

    async function startPolling(){
      clearInterval(pollTimer);
      if(!hasOnline()) return;
      pollTimer = setInterval(async ()=>{
        if(syncing || dirty) return;
        try{
          const remote = await fetchRemote();
          const sig = signatureOf(remote);
          if(!lastRemoteSig) lastRemoteSig = sig;
          if(sig !== lastRemoteSig){
            state.items = mergeItemsById(state.items, remote.items);
            state.dispatches = mergeDispatches(state.dispatches, remote.dispatches);
            saveCache();
            lastRemoteSig = signatureOf(state);
            render();
          }
        }catch(e){}
      }, 15000);
    }

    function withEditorSuffix(ts){
      if(!settings.editorName) return ts;
      return `${ts} ‚Äî ${settings.editorName}`;
    }

    function seedIfEmpty(){
      if(state.items.length !== 0) return;
      state.items = [{
        id: uuid(),
        bmId: "Exemplo: BM Planejamento",
        column: "standby",
        quality: "APROVADO",
        numbers: [],
        notes: "Use Programa√ß√£o para gerar o texto (MARCOS / SPORT...).",
        createdAt: todayISO(),
        updatedAt: withEditorSuffix(nowISO()),
        disparoDate: "",
        disparoWeekday: "",
        isDone: false,
        doneAt: ""
      }];
    }

    // ======= URL HASH -> settings =======
    function parseHashSettings(){
      const hash = (location.hash || "").replace(/^#/, "").trim();
      if(!hash) return;
      const params = new URLSearchParams(hash);
const key = params.get("key");
      const editor = params.get("editor");
      let changed = false;
if(key && key.trim()){
        settings.editKey = decodeURIComponent(key.trim());
        changed = true;
      }
      if(editor && editor.trim()){
        settings.editorName = decodeURIComponent(editor.trim());
        changed = true;
      }
      if(changed){
        saveSettings();
        toast("Modo/config carregado pelo link.");
      }
    }

    async function bootstrap(){
      loadSettings();
      parseHashSettings();
      loadCache();
      seedIfEmpty();

      // set programa√ß√£o date default
      $("#progDate").value = todayISO();

      if(!hasOnline()){
        saveCache();
        updateEditUI();
        render();
        return;
      }

      try{
        const remote = await fetchRemote();
        state.items = mergeItemsById(state.items, remote.items);
        state.dispatches = mergeDispatches(state.dispatches, remote.dispatches);

        // se online vazio e tem chave -> publica estado
        const remoteEmpty = (remote.items||[]).length === 0 && (remote.dispatches||[]).length === 0;
        if(remoteEmpty && canSync()){
          toast("Online vazio. Publicando seus dados locais‚Ä¶");
          syncing = true;
          updateEditUI();
          await pushRemote();
          syncing = false;
          dirty = false;
          toast("Publicado no online.");
        }

        saveCache();
        lastRemoteSig = signatureOf(state);
        updateEditUI();
        render();
        startPolling();
      }catch(e){
        console.error(e);
        setSyncUI("offline_cache");
        updateEditUI();
        render();
      }
    }

    // ======= Render: Board =======
    function renderBoard(){
      const board = $("#board");
      board.innerHTML = "";
      for(const col of COLUMNS){
        const items = state.items
          .filter(it => it.column === col.id)
          .filter(matchesFilters)
          .sort((a,b)=> (a.createdAt > b.createdAt ? -1 : 1));

        const colEl = document.createElement("div");
        colEl.className = "col";
        colEl.innerHTML = `
          <div class="col-header">
            <b>${col.name}</b>
            <span class="badge">${items.length}</span>
          </div>
          <div class="dropzone" data-col="${col.id}"></div>
        `;

        const dz = colEl.querySelector(".dropzone");
        if(canEdit()){
          dz.addEventListener("dragover", (e)=>{ e.preventDefault(); dz.classList.add("dragover"); });
          dz.addEventListener("dragleave", ()=> dz.classList.remove("dragover"));
          dz.addEventListener("drop", (e)=>{
            e.preventDefault();
            dz.classList.remove("dragover");
            const id = e.dataTransfer.getData("text/plain");
            moveItem(id, col.id);
          });
        }

        for(const it of items){
          const card = document.createElement("div");
          card.className = "card" + (canEdit() ? "" : " readonly");
          card.draggable = canEdit();

          const q = it.quality || "MEDIA";
          const nums = (it.numbers || []).length;
          const sched = scheduleLabel(it);
          const doneBadge = it.isDone ? `<span class="chip"><strong>Disparado</strong> ‚Ä¢ ${toBR(it.doneAt || "")}</span>` : "";

          card.innerHTML = `
            <div class="card-top">
              <div style="min-width:0">
                <div class="bm-id" title="${escapeHtml(it.bmId)}">üè∑Ô∏è ${escapeHtml(it.bmId)}</div>
                <div class="meta">
                  <span class="chip"><strong>üìå ${toBR(it.createdAt)}</strong></span>
                  ${qualityChip(q)}
                  <span class="chip"><strong>‚òéÔ∏è ${nums}/10</strong></span>
                  <span class="chip"><strong>${sched}</strong></span>
                  ${doneBadge}
                </div>
                ${it.notes ? `<div class="small" style="margin-top:8px">${escapeHtml(it.notes).slice(0,140)}${(it.notes.length>140?"‚Ä¶":"")}</div>` : `<div class="small" style="margin-top:8px">Sem observa√ß√µes.</div>`}
              </div>
              <div class="actions">
                <button class="iconbtn" data-action="edit">‚úèÔ∏è</button>
              </div>
            </div>
          `;

          if(canEdit()){
            card.addEventListener("dragstart", (e)=>{
              e.dataTransfer.setData("text/plain", it.id);
              e.dataTransfer.effectAllowed = "move";
            });
          }
          card.querySelector('[data-action="edit"]').addEventListener("click", ()=>openModal(it.id));
          dz.appendChild(card);
        }
        board.appendChild(colEl);
      }
    }

    // ======= Render: Agenda =======
    function renderAgenda(){
      const upcoming = $("#agendaUpcoming");
      const done = $("#agendaDone");
      upcoming.innerHTML = "";
      done.innerHTML = "";

      const filtered = state.items.filter(matchesFilters);
      const doneItems = filtered.filter(i=>i.isDone).sort((a,b)=> (a.doneAt||"").localeCompare(b.doneAt||""));
      const upcomingItems = filtered.filter(i=>!i.isDone).filter(i=>i.disparoDate||i.disparoWeekday);

      const groups = new Map();
      for(const it of upcomingItems){
        const key = it.disparoDate ? ("D:" + it.disparoDate) : ("W:" + it.disparoWeekday);
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it);
      }

      if(groups.size === 0){
        upcoming.innerHTML = `<div class="small muted">Nenhum disparo agendado ainda.</div>`;
      }else{
        for(const [key, arr] of groups.entries()){
          const header = document.createElement("div");
          header.className = "row";
          header.innerHTML = `
            <div class="row-left">
              <div><b>${escapeHtml(arr[0].disparoDate ? `üìÖ ${toBR(arr[0].disparoDate)}` : `üóìÔ∏è ${scheduleLabel(arr[0]).replace(/^üóìÔ∏è /,"")}`)}</b></div>
              <div class="small">${arr.length} BM(s)</div>
            </div>
            <div class="row-right"><span class="kbd">Clique em uma BM</span></div>
          `;
          upcoming.appendChild(header);

          const list = document.createElement("div");
          list.className = "list";
          list.style.margin = "10px 0 14px";
          for(const it of arr){
            const r = document.createElement("div");
            r.className = "row";
            r.innerHTML = `
              <div class="row-left" style="min-width:0">
                <div class="mono" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><b>${escapeHtml(it.bmId)}</b></div>
                <div class="small">Criada em <b>${toBR(it.createdAt)}</b> ‚Ä¢ Status: <b>${escapeHtml(getColumnName(it.column))}</b></div>
              </div>
              <div class="row-right">
                ${qualityChip(it.quality || "MEDIA")}
                <button class="btn" data-edit="${it.id}">${canEdit() ? "Editar" : "Ver"}</button>
                <button class="btn primary" data-done="${it.id}" ${canEdit() ? "" : "disabled"}>Marcar Disparado</button>
              </div>
            `;
            r.querySelector('[data-edit]').addEventListener("click", ()=>openModal(it.id));
            r.querySelector('[data-done]').addEventListener("click", ()=>{ if(canEdit()) { markDone(it.id, todayISO()); toast("Marcado como disparado."); }});
            list.appendChild(r);
          }
          upcoming.appendChild(list);
        }
      }

      if(doneItems.length === 0){
        done.innerHTML = `<div class="small muted">Ainda n√£o h√° itens no hist√≥rico.</div>`;
      }else{
        for(const it of doneItems.slice().reverse()){
          const r = document.createElement("div");
          r.className = "row";
          r.innerHTML = `
            <div class="row-left" style="min-width:0">
              <div class="mono" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><b>${escapeHtml(it.bmId)}</b></div>
              <div class="small">Disparado em <b>${toBR(it.doneAt)}</b> ‚Ä¢ Criada em <b>${toBR(it.createdAt)}</b></div>
            </div>
            <div class="row-right">
              ${qualityChip(it.quality || "MEDIA")}
              <button class="btn" data-edit="${it.id}">${canEdit() ? "Editar" : "Ver"}</button>
              <button class="btn" data-undone="${it.id}" ${canEdit() ? "" : "disabled"}>Desfazer</button>
            </div>
          `;
          r.querySelector('[data-edit]').addEventListener("click", ()=>openModal(it.id));
          r.querySelector('[data-undone]').addEventListener("click", ()=>{ if(canEdit()) { unmarkDone(it.id); toast("Removido do hist√≥rico."); }});
          done.appendChild(r);
        }
      }
    }

    // ======= Programa√ß√£o =======
    function getProgDate(){
      return $("#progDate").value || todayISO();
    }

    function dispatchesForDate(dateISO){
      return (state.dispatches || []).filter(d => d.date === dateISO);
    }

    function computeTotals(dateISO){
      const list = dispatchesForDate(dateISO);
      const totalLines = list.length;
      const totalQty = list.reduce((acc, d)=> acc + (Number(d.qty)||0), 0);
      $("#progTotals").textContent = `${totalLines} linhas ‚Ä¢ ${totalQty} disparos`;
    }

    function renderProg(){
      const dateISO = getProgDate();
      const tbody = $("#progBody");
      tbody.innerHTML = "";

      const list = dispatchesForDate(dateISO)
        .slice()
        .sort((a,b)=> (a.operator||"").localeCompare(b.operator||"") || (a.time||"").localeCompare(b.time||""));

      for(const d of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input class="cell-input" value="${escapeHtml(d.operator||"")}" data-k="operator" data-id="${d.id}" placeholder="Ex: MARCOS" /></td>
          <td><input class="cell-input mini2" value="${escapeHtml(d.code||"")}" data-k="code" data-id="${d.id}" placeholder="Ex: 5768" /></td>
          <td><input class="cell-input mini" type="number" value="${escapeHtml(String(d.qty||""))}" data-k="qty" data-id="${d.id}" placeholder="Ex: 100" /></td>
          <td><input class="cell-input mini2" type="time" value="${escapeHtml(d.time||"")}" data-k="time" data-id="${d.id}" /></td>
          <td class="nowrap"><button class="trash" title="Excluir" data-del="${d.id}">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(tr);
      }

      // bind events
      tbody.querySelectorAll("input[data-k]").forEach(inp=>{
        inp.addEventListener("change", ()=>{
          if(!canEdit()){ toast("Somente leitura."); renderProg(); return; }
          const id = inp.getAttribute("data-id");
          const key = inp.getAttribute("data-k");
          let val = inp.value;
          if(key === "operator") val = String(val||"").trim().toUpperCase();
          if(key === "code") val = String(val||"").trim();
          if(key === "qty") val = Number(val||0);
          if(key === "time") val = String(val||"").trim();
          updateDispatch(id, { [key]: val });
        });
      });
      tbody.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(!canEdit()){ toast("Somente leitura."); return; }
          const id = btn.getAttribute("data-del");
          deleteDispatch(id);
        });
      });

      computeTotals(dateISO);
      $("#progOutput").textContent = generateText(dateISO);
    }

    function addDispatchRow(patch={}){
      if(!canEdit()){ toast("Somente leitura."); return; }
      const dateISO = getProgDate();
      const d = {
        id: uuid(),
        date: dateISO,
        operator: (patch.operator || "OPERADOR").toUpperCase(),
        code: patch.code || "",
        qty: Number(patch.qty || 0),
        time: patch.time || ""
      };
      state.dispatches.unshift(d);
      saveCache();
      renderProg();
      scheduleSync();
    }

    function updateDispatch(id, patch){
      const idx = state.dispatches.findIndex(d=>d.id===id);
      if(idx < 0) return;
      state.dispatches[idx] = { ...state.dispatches[idx], ...patch };
      saveCache();
      renderProg();
      scheduleSync();
    }

    function deleteDispatch(id){
      state.dispatches = state.dispatches.filter(d=>d.id!==id);
      saveCache();
      renderProg();
      scheduleSync();
    }

    function generateText(dateISO){
      const list = dispatchesForDate(dateISO).slice();
      // group by operator, keep a stable order based on first appearance sorted by operator name
      const ops = Array.from(new Set(list.map(d => (d.operator||"").trim().toUpperCase()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      const out = [];
      for(const op of ops){
        out.push(op);
        out.push("");
        const rows = list
          .filter(d => (d.operator||"").trim().toUpperCase() === op)
          .slice()
          .sort((a,b)=> (a.time||"").localeCompare(b.time||"") || String(a.code||"").localeCompare(String(b.code||"")));
        for(const r of rows){
          const code = String(r.code||"").trim();
          const qty = Number(r.qty||0);
          const time = String(r.time||"").trim() || "00:00";
          if(!code) continue;
          out.push(`${code} - ${qty} (${time})`);
        }
        out.push("");
      }
      return out.join("\n").trim() + "\n";
    }

    function parseProgramText(text, dateISO){
      // Parse groups + lines like: 5768 - 100 (09:30)
      const lines = String(text||"").split(/\r?\n/);
      let currentOp = "";
      const created = [];
      for(const raw of lines){
        const line = raw.trim();
        if(!line) continue;
        // entry line
        const m = line.match(/^(.+?)\s*-\s*(\d+)\s*\((\d{2}:\d{2})\)\s*$/);
        if(m){
          const code = String(m[1]||"").trim();
          const qty = Number(m[2]||0);
          const time = String(m[3]||"").trim();
          if(!currentOp) currentOp = "OPERADOR";
          created.push({operator: currentOp.toUpperCase(), code, qty, time});
          continue;
        }
        // operator header (any non-entry line)
        currentOp = line.toUpperCase();
      }
      for(const c of created){
        addDispatchRow({ operator:c.operator, code:c.code, qty:c.qty, time:c.time });
      }
      return created.length;
    }

    // ======= Render all =======
    function render(){
      renderBoard();
      renderAgenda();
      renderProg();
      updateEditUI();
    }

    // ======= CRUD Items =======
    function createItem(payload){
      if(!canEdit()) return;
      const item = {
        id: uuid(),
        bmId: (payload.bmId || "").trim() || "BM sem nome",
        column: payload.column || "standby",
        quality: payload.quality || "MEDIA",
        numbers: payload.numbers || [],
        notes: payload.notes || "",
        createdAt: payload.createdAt || todayISO(),
        updatedAt: withEditorSuffix(nowISO()),
        disparoDate: payload.disparoDate || "",
        disparoWeekday: payload.disparoWeekday || "",
        isDone: !!payload.isDone,
        doneAt: payload.doneAt || ""
      };
      state.items.unshift(item);
      saveCache();
      render();
      scheduleSync();
    }
    function updateItem(id, patch){
      if(!canEdit()) return;
      const idx = state.items.findIndex(i=>i.id===id);
      if(idx < 0) return;
      const before = state.items[idx];
      state.items[idx] = { ...before, ...patch, createdAt: before.createdAt || todayISO(), updatedAt: withEditorSuffix(nowISO()) };
      saveCache();
      render();
      scheduleSync();
    }
    function deleteItem(id){
      if(!canEdit()) return;
      state.items = state.items.filter(i=>i.id!==id);
      saveCache();
      render();
      scheduleSync();
    }
    function moveItem(id, columnId){ updateItem(id, { column: columnId }); }
    function markDone(id, doneAt){ updateItem(id, { isDone:true, doneAt: doneAt || todayISO() }); }
    function unmarkDone(id){ updateItem(id, { isDone:false, doneAt:"" }); }

    // ======= Modal BM =======
    function openModal(id){
      currentId = id || null;
      const isNew = !id;

      $("#modalTitle").textContent = isNew ? "Nova BM" : (canEdit() ? "Editar BM" : "Visualizar BM");
      $("#fColumn").innerHTML = COLUMNS.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");

      let item = null;
      if(!isNew) item = state.items.find(i=>i.id===id);

      $("#fBmId").value = item?.bmId || "";
      $("#fColumn").value = item?.column || "standby";
      $("#fQuality").value = item?.quality || "MEDIA";
      $("#fNumbers").value = (item?.numbers || []).join("\n");
      $("#fNotes").value = item?.notes || "";
      $("#fCreatedAt").value = item ? `${toBR(item.createdAt)} (${item.createdAt})` : `${toBR(todayISO())} (${todayISO()})`;
      $("#fUpdatedAt").value = item?.updatedAt || "‚Äî";
      $("#fDisparoDate").value = item?.disparoDate || "";
      $("#fDisparoWeekday").value = item?.disparoWeekday || "";
      $("#fIsDone").checked = !!item?.isDone;
      $("#fDoneAt").value = item?.doneAt || "";

      const lock = !canEdit();
      ["fBmId","fColumn","fQuality","fNumbers","fNotes","fDisparoDate","fDisparoWeekday","fIsDone","fDoneAt"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.disabled = lock;
      });
      $("#btnSave").disabled = lock;
      $("#btnDelete").style.display = (isNew || lock) ? "none" : "inline-flex";
      $("#editHint").textContent = !hasOnline() ? "Modo: Local" : (canSync() ? "Modo: Online (edi√ß√£o)" : "Modo: Online (leitura)");

      $("#numbersCount").textContent = `${normalizeNumbers($("#fNumbers").value).length}/10`;

      $("#modalBackdrop").classList.add("open");
      $("#modalBackdrop").setAttribute("aria-hidden", "false");
    }
    function closeModal(){
      $("#modalBackdrop").classList.remove("open");
      $("#modalBackdrop").setAttribute("aria-hidden", "true");
      currentId = null;
    }

    // ======= Settings modal =======
    function openSettings(){
      $("#sApiUrl").value = settings.apiUrl || "";
      $("#sEditKey").value = settings.editKey || "";
      $("#sEditor").value = settings.editorName || "";
      $("#pingResult").textContent = "‚Äî";
      $("#settingsBackdrop").classList.add("open");
      $("#settingsBackdrop").setAttribute("aria-hidden","false");
    }
    function closeSettings(){
      $("#settingsBackdrop").classList.remove("open");
      $("#settingsBackdrop").setAttribute("aria-hidden","true");
    }

    // ======= Import Programa√ß√£o modal =======
    function openImportProg(){
      $("#importProgText").value = "";
      $("#importProgBackdrop").classList.add("open");
      $("#importProgBackdrop").setAttribute("aria-hidden","false");
      setTimeout(()=>$("#importProgText").focus(), 60);
    }
    function closeImportProg(){
      $("#importProgBackdrop").classList.remove("open");
      $("#importProgBackdrop").setAttribute("aria-hidden","true");
    }

    // ======= Events =======
    $("#btnAdd").addEventListener("click", ()=>openModal(null));
    $("#btnClose").addEventListener("click", closeModal);
    $("#btnCancel").addEventListener("click", closeModal);
    $("#modalBackdrop").addEventListener("click", (e)=>{ if(e.target === $("#modalBackdrop")) closeModal(); });

    $("#fNumbers").addEventListener("input", ()=>{ $("#numbersCount").textContent = `${normalizeNumbers($("#fNumbers").value).length}/10`; });

    $("#btnSave").addEventListener("click", ()=>{
      if(!canEdit()) return;
      const bmId = $("#fBmId").value.trim();
      if(!bmId){ toast("Informe a identifica√ß√£o da BM."); $("#fBmId").focus(); return; }

      const numbers = normalizeNumbers($("#fNumbers").value);
      const column = $("#fColumn").value;
      const quality = $("#fQuality").value;
      const notes = $("#fNotes").value.trim();
      const disparoDate = $("#fDisparoDate").value;
      const disparoWeekday = $("#fDisparoWeekday").value;
      const isDone = $("#fIsDone").checked;
      const doneAt = $("#fDoneAt").value || (isDone ? todayISO() : "");

      if(currentId) updateItem(currentId, { bmId, column, quality, numbers, notes, disparoDate, disparoWeekday, isDone, doneAt });
      else createItem({ bmId, column, quality, numbers, notes, createdAt: todayISO(), disparoDate, disparoWeekday, isDone, doneAt });

      closeModal();
    });

    $("#btnDelete").addEventListener("click", ()=>{
      if(!canEdit() || !currentId) return;
      const it = state.items.find(i=>i.id===currentId);
      if(!it) return;
      const ok = confirm(`Excluir "${it.bmId}"?`);
      if(!ok) return;
      deleteItem(currentId);
      closeModal();
    });

    // Search / filter
    $("#search").addEventListener("input", render);
    $("#filterQuality").addEventListener("change", render);

    // Tabs
    function setTab(which){
      const isBoard = which === "board";
      const isAgenda = which === "agenda";
      const isProg = which === "prog";
      $("#tabBoard").classList.toggle("active", isBoard);
      $("#tabAgenda").classList.toggle("active", isAgenda);
      $("#tabProg").classList.toggle("active", isProg);
      $("#viewBoard").style.display = isBoard ? "block" : "none";
      $("#viewAgenda").style.display = isAgenda ? "block" : "none";
      $("#viewProg").style.display = isProg ? "block" : "none";
      if(isProg) renderProg();
    }
    $("#tabBoard").addEventListener("click", ()=>setTab("board"));
    $("#tabAgenda").addEventListener("click", ()=>setTab("agenda"));
    $("#tabProg").addEventListener("click", ()=>setTab("prog"));

    // Export / Import / Reset
    $("#btnExport").addEventListener("click", ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `organizador_bms_${todayISO()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Exportado.");
    });

    $("#btnImport").addEventListener("click", ()=> $("#importFile").click());
    $("#importFile").addEventListener("change", async (e)=>{
      if(!canEdit()){ toast("Somente leitura."); e.target.value=""; return; }
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        if(!parsed || !Array.isArray(parsed.items)) throw new Error("Formato inv√°lido.");
        if(!Array.isArray(parsed.dispatches)) parsed.dispatches = [];
        state.items = parsed.items;
        state.dispatches = parsed.dispatches;
        saveCache();
        render();
        scheduleSync();
        toast("Importado.");
      }catch(err){
        console.error(err);
        toast("Falha ao importar (arquivo inv√°lido).");
      }finally{
        e.target.value = "";
      }
    });

    $("#btnReset").addEventListener("click", ()=>{
      if(!canEdit()){ toast("Somente leitura."); return; }
      const ok = confirm("Isso vai apagar tudo deste navegador (e do online se estiver em edi√ß√£o). Continuar?");
      if(!ok) return;
      state = { items: [], dispatches: [] };
      seedIfEmpty();
      saveCache();
      render();
      scheduleSync();
      toast("Dados limpos.");
    });

    // Settings modal
    $("#btnSettings").addEventListener("click", openSettings);
    $("#btnSettingsClose").addEventListener("click", closeSettings);
    $("#btnSettingsCancel").addEventListener("click", closeSettings);
    $("#settingsBackdrop").addEventListener("click", (e)=>{ if(e.target === $("#settingsBackdrop")) closeSettings(); });

    $("#btnSettingsSave").addEventListener("click", async ()=>{
      settings.apiUrl = ($("#sApiUrl").value || "").trim();
      settings.editKey = ($("#sEditKey").value || "").trim();
      settings.editorName = ($("#sEditor").value || "").trim();
      saveSettings();
      closeSettings();
      toast("Config salva. Conectando‚Ä¶");
      dirty = false; syncing = false; lastRemoteSig = "";
      await bootstrap();
    });

    $("#btnClearSettings").addEventListener("click", ()=>{
      const ok = confirm("Limpar configura√ß√£o online deste navegador?");
      if(!ok) return;
      settings = { apiUrl:"", editKey:"", editorName:"" };
      saveSettings();
      closeSettings();
      toast("Config limpa.");
      dirty = false; syncing = false; lastRemoteSig = "";
      updateEditUI();
      render();
    });

    $("#btnPing").addEventListener("click", async ()=>{
      const url = ($("#sApiUrl").value || "").trim();
      if(!url){ $("#pingResult").textContent = "Informe a URL."; return; }
      $("#pingResult").textContent = "Testando‚Ä¶";
      try{
        const res = await fetch(url, { method:"GET", cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if(!data || !Array.isArray(data.items)) throw new Error("Formato inv√°lido");
        $("#pingResult").textContent = "OK ‚Äî retornou {items:[‚Ä¶]}";
      }catch(e){
        $("#pingResult").textContent = "Falhou ‚Äî " + (e?.message || "erro");
      }
    });

    // Programa√ß√£o events
    $("#progDate").addEventListener("change", ()=>renderProg());
    $("#btnAddLine").addEventListener("click", ()=>addDispatchRow({operator:"", code:"", qty:0, time:""}));
    $("#btnGenerate").addEventListener("click", ()=>{
      const t = generateText(getProgDate());
      $("#progOutput").textContent = t;
      toast("Texto gerado.");
    });
    $("#btnCopy").addEventListener("click", async ()=>{
      const text = $("#progOutput").textContent || "";
      if(!text.trim()){ toast("Nada para copiar."); return; }
      try{
        await navigator.clipboard.writeText(text);
        toast("Copiado.");
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Copiado.");
      }
    });
    $("#btnImportText").addEventListener("click", ()=>openImportProg());
    $("#btnImportProgClose").addEventListener("click", closeImportProg);
    $("#btnImportProgCancel").addEventListener("click", closeImportProg);
    $("#importProgBackdrop").addEventListener("click", (e)=>{ if(e.target === $("#importProgBackdrop")) closeImportProg(); });
    $("#btnImportProgRun").addEventListener("click", ()=>{
      if(!canEdit()){ toast("Somente leitura."); return; }
      const txt = $("#importProgText").value || "";
      const count = parseProgramText(txt, getProgDate());
      closeImportProg();
      toast(`Importado: ${count} linha(s).`);
      renderProg();
    });

    // Keyboard
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        if($("#modalBackdrop").classList.contains("open")) closeModal();
        if($("#settingsBackdrop").classList.contains("open")) closeSettings();
        if($("#importProgBackdrop").classList.contains("open")) closeImportProg();
      }
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
        e.preventDefault(); $("#search").focus();
      }
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "n"){
        e.preventDefault();
        if(canEdit()) openModal(null);
        else toast("Somente leitura.");
      }
    });

    // ======= INIT =======
    bootstrap();
  </script>
</body>
</html>
