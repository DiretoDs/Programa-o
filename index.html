<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Organizador de BMs ‚Äî Online + Programa√ß√£o</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e7eefc;
      --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:12px;
      --accent:#4f9cff;
      --good:#35d07f;
      --mid:#f7c948;
      --bad:#ff5b5b;
      --chip:#1a2a49;
      --focus:0 0 0 3px rgba(79,156,255,.25);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 15% 10%, rgba(79,156,255,.16), transparent 60%),
                  radial-gradient(900px 700px at 85% 20%, rgba(53,208,127,.10), transparent 55%),
                  radial-gradient(900px 700px at 75% 90%, rgba(247,201,72,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    button, input, select, textarea{font:inherit;color:inherit}
    .app{max-width:1500px;margin:0 auto;padding:18px 16px 28px;}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 14px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 0; backdrop-filter: blur(8px); z-index: 5;
    }
    .brand{display:flex;gap:12px;align-items:center;min-width:260px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(79,156,255,.95), rgba(79,156,255,.25));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 25px rgba(79,156,255,.18);
    }
    .title{display:flex;flex-direction:column;line-height:1.15}
    .title b{font-size:15px;letter-spacing:.2px}
    .title span{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      padding:10px 10px; border-radius: 999px;
    }
    .pill input{border:0;outline:0;background:transparent;min-width:240px;}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:10px 12px;border-radius:999px;cursor:pointer;transition:.15s ease;
      display:inline-flex;gap:8px;align-items:center;white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.08)}
    .btn:active{transform:translateY(0px)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .btn.primary{
      background: linear-gradient(135deg, rgba(79,156,255,.92), rgba(79,156,255,.35));
      border:1px solid rgba(79,156,255,.55);
      box-shadow: 0 10px 24px rgba(79,156,255,.18);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,91,91,.9), rgba(255,91,91,.25));
      border:1px solid rgba(255,91,91,.55);
      box-shadow: 0 10px 24px rgba(255,91,91,.14);
    }
    .btn.ghost{background:transparent;}
    .tabs{
      display:flex;gap:8px;align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      padding:6px;border-radius:999px;
    }
    .tab{border:0;background:transparent;padding:9px 12px;border-radius:999px;cursor:pointer;color:var(--muted)}
    .tab.active{background: rgba(255,255,255,.08);color: var(--text);border:1px solid rgba(255,255,255,.10)}
    .statuspill{
      display:flex;gap:8px;align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;border-radius:999px;font-size:12px;color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.25);}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.mid{background:var(--mid)}
    .content{margin-top:14px;}
    .board{display:flex;gap:12px;overflow-x:auto;padding-bottom:10px;}
    .col{
      min-width:320px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .col-header{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:6px 4px 10px;
      border-bottom:1px dashed rgba(255,255,255,.10);
      margin-bottom:10px;
    }
    .col-header b{font-size:13px}
    .badge{
      font-size:12px;padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
    }
    .dropzone{min-height:60px;display:flex;flex-direction:column;gap:10px;padding:2px;border-radius: var(--radius2);}
    .dropzone.dragover{
      outline: 2px dashed rgba(79,156,255,.55);
      outline-offset: 4px;
      background: rgba(79,156,255,.06);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
      padding:10px;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      cursor: grab;
    }
    .card.readonly{cursor: default;}
    .card:active{cursor: grabbing}
    .card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px;}
    .bm-id{
      font-family: var(--mono);font-size: 12px;letter-spacing: .2px;
      background: rgba(26,42,73,.7);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 8px;border-radius:10px;
      display:inline-flex;gap:8px;align-items:center;
      max-width: 240px;overflow:hidden;text-overflow: ellipsis;white-space: nowrap;
    }
    .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px;}
    .chip{
      font-size:12px;padding:6px 8px;border-radius:999px;
      background: rgba(26,42,73,.55);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      display:inline-flex;gap:6px;align-items:center;
    }
    .chip strong{color:var(--text);font-weight:600}
    .qdot{width:8px;height:8px;border-radius:999px;display:inline-block;}
    .qdot.good{background:var(--good)}
    .qdot.mid{background:var(--mid)}
    .qdot.bad{background:var(--bad)}
    .small{font-size: 12px;color: var(--muted);line-height: 1.35;}
    .actions{display:flex;gap:8px;align-items:center;}
    .iconbtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      width:36px;height:36px;border-radius: 12px;cursor:pointer;
      display:grid;place-items:center;transition:.15s ease;flex: 0 0 auto;
    }
    .iconbtn:hover{background: rgba(255,255,255,.08); transform: translateY(-1px)}
    .iconbtn:active{transform: translateY(0px)}
    .warn{color: rgba(255,91,91,.92);font-weight: 600;}
    .grid2col{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 980px){ .grid2col{grid-template-columns:1fr;} }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .panel h3{margin: 6px 0 10px;font-size: 14px;letter-spacing: .2px;}
    .list{display:flex;flex-direction:column;gap:10px;}
    .row{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px;border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);background: rgba(255,255,255,.03);
    }
    .row-left{display:flex;flex-direction:column;gap:6px;min-width: 0}
    .row-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .kbd{
      font-family: var(--mono);
      font-size: 12px;color: var(--muted);
      padding: 4px 8px;border-radius: 10px;
      border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.04);
    }
    .prog-grid{display:grid;grid-template-columns: 1.25fr .75fr;gap:12px;}
    @media (max-width: 980px){ .prog-grid{grid-template-columns:1fr;} }
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
    .toolbar-left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toolbar-right{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .field-inline{
      display:flex;gap:8px;align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;border-radius:999px;
      color: var(--muted);font-size:12px;
    }
    .field-inline input,.field-inline select{
      border:0;outline:0;background:transparent;color:var(--text);
      font-size:12px;
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:middle;
      font-size:12px;
    }
    .table th{
      text-align:left;
      color: var(--muted);
      background: rgba(255,255,255,.03);
      position:sticky;
      top:0;
      z-index:1;
    }
    .table tr:last-child td{border-bottom:0}
    .cell-input{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 10px;
      padding:8px 8px;
      outline:none;
      font-size:12px;
    }
    .cell-input:disabled{opacity:.55}
    .mini{width: 90px;}
    .mini2{width: 120px;}
    .nowrap{white-space:nowrap}
    .trash{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 10px;
      width:36px;height:36px;
      cursor:pointer;
    }
    .trash:disabled{opacity:.45; cursor:not-allowed}
    pre.output{
      margin:0;
      padding:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.5;
      min-height: 420px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .modal-backdrop{
      position:fixed; inset:0;background: rgba(0,0,0,.55);
      display:none; place-items:center; z-index: 10; padding: 14px;
    }
    .modal-backdrop.open{display:grid}
    .modal{
      width:min(980px, 100%);
      background: linear-gradient(180deg, rgba(16,31,54,.98), rgba(15,26,46,.98));
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 28px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal.sm{width:min(720px, 100%);}
    .modal-header{
      padding:14px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.03);
    }
    .modal-header b{font-size:14px}
    .modal-body{
      padding:14px;display:grid;grid-template-columns: 1.15fr .85fr;gap:12px;
    }
    .modal-body.one{grid-template-columns:1fr;}
    @media (max-width: 920px){ .modal-body{grid-template-columns: 1fr;} }
    .field{
      display:flex;flex-direction:column;gap:6px;
      padding:10px;border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;background: rgba(255,255,255,.03);
    }
    .field label{font-size:12px; color: var(--muted)}
    .field input,.field select,.field textarea{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      padding:10px 10px;
      outline: none;
    }
    textarea{min-height:140px; resize: vertical}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 520px){ .grid2{grid-template-columns:1fr} }
    .modal-footer{
      padding:14px;display:flex;justify-content:space-between;gap:10px;
      border-top:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.02);
      flex-wrap:wrap;
    }
    .hint{font-size:12px; color: var(--muted)}
    .hr{height:1px; background: rgba(255,255,255,.08); margin: 10px 0}
    .toast{
      position:fixed;right:16px;bottom:16px;
      background: rgba(20,34,60,.92);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding:10px 12px;border-radius: 14px;
      box-shadow: var(--shadow);
      display:none;max-width: 560px;z-index: 20;
    }
    .toast.show{display:block}
    .mono{font-family: var(--mono)}
    .muted{color: var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>Organizador de BMs</b>
          <span>Somente Leitura por padr√£o ‚Ä¢ Edi√ß√£o s√≥ pelo link</span>
        </div>
      </div>

      <div class="controls">
        <div class="tabs" role="tablist" aria-label="Modo">
          <button class="tab active" id="tabBoard">Board</button>
          <button class="tab" id="tabAgenda">Agenda</button>
          <button class="tab" id="tabProg">Programa√ß√£o</button>
        </div>

        <div class="statuspill" title="Status de acesso">
          <span class="dot" id="syncDot"></span>
          <span id="syncText">Leitura</span>
        </div>

        <button class="btn" id="btnSettings">‚öôÔ∏è Conectar</button>

        <div class="pill" title="Buscar por BM, observa√ß√£o ou n√∫mero">
          <span style="opacity:.85">üîé</span>
          <input id="search" placeholder="Buscar (ex: 5768, 'cart√£o', 'template'...)" />
        </div>

        <select id="filterQuality" class="btn" title="Filtrar por qualidade">
          <option value="">Qualidade: Todas</option>
          <option value="APROVADO">Aprovado</option>
          <option value="MEDIA">Qualidade m√©dia</option>
          <option value="BAIXA">Qualidade baixa (risco)</option>
        </select>

        <button class="btn primary" id="btnAdd">Ôºã Nova BM</button>
        <button class="btn" id="btnExport">Exportar</button>
        <button class="btn" id="btnImport">Importar</button>
        <input type="file" id="importFile" accept="application/json" style="display:none" />
        <button class="btn danger" id="btnReset" title="Apaga tudo deste navegador">Limpar</button>
      </div>
    </div>

    <div class="content">
      <div id="viewBoard">
        <div class="board" id="board"></div>
        <div class="panel" style="margin-top:12px">
          <h3>Leitura x Edi√ß√£o (simples)</h3>
          <div class="small">
            <b>Leitura:</b> <span class="mono">#api=URL_DA_API</span><br>
            <b>Edi√ß√£o:</b> <span class="mono">#api=URL_DA_API&key=SUA_CHAVE&editor=Planejamento&edit=1</span>
          </div>
        </div>
      </div>

      <div id="viewAgenda" style="display:none">
        <div class="grid2col">
          <div class="panel">
            <h3>Agenda de Programa√ß√£o (prioridade)</h3>
            <div class="small">Mostra: <b>Data</b>, <b>Hor√°rio de cada n√∫mero</b> e <b>Quantidade</b> (separado por Carteira).</div>
            <div class="hr"></div>
            <div id="agendaProg" class="list"></div>
          </div>

          <div class="panel">
            <h3>Agenda de BMs</h3>
            <div class="small">Agendamento vindo das BMs (controle paralelo).</div>
            <div class="hr"></div>
            <div id="agendaBms" class="list"></div>
          </div>
        </div>
      </div>

      <div id="viewProg" style="display:none">
        <div class="prog-grid">
          <div class="panel">
            <div class="toolbar">
              <div class="toolbar-left">
                <div class="field-inline">
                  <span>üìÖ Data:</span>
                  <input id="progDate" type="date" />
                </div>
                <div class="field-inline">
                  <span>üìå Carteira:</span>
                  <select id="progBucket">
                    <option value="GBR_CLT">GBR CLT</option>
                    <option value="GBR_NOVO">GBR NOVO</option>
                    <option value="3P_CLT">3P CLT</option>
                    <option value="3P PORT">3P PORT</option>
                  </select>
                </div>
                <button class="btn" id="btnAddLine">Ôºã Linha</button>
                <button class="btn" id="btnImportText">Importar texto</button>
              </div>
              <div class="toolbar-right">
                <span class="kbd" id="progTotals">0 linhas ‚Ä¢ 0 disparos</span>
                <button class="btn primary" id="btnGenerate">Gerar texto</button>
                <button class="btn" id="btnCopy">Copiar</button>
              </div>
            </div>

            <div style="max-height:520px; overflow:auto; border-radius:14px;">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width:190px">Operador</th>
                    <th style="width:140px">4 d√≠gitos</th>
                    <th style="width:120px">Qtd</th>
                    <th style="width:140px">Hora</th>
                    <th style="width:90px" class="nowrap">A√ß√£o</th>
                  </tr>
                </thead>
                <tbody id="progBody"></tbody>
              </table>
            </div>
          </div>

          <div class="panel">
            <h3>Texto gerado</h3>
            <pre class="output" id="progOutput"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BM modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <b id="modalTitle">BM</b>
        <button class="btn ghost" id="btnClose">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="field">
            <label>Identifica√ß√£o da BM</label>
            <input id="fBmId" />
          </div>

          <div class="grid2">
            <div class="field">
              <label>Status (coluna)</label>
              <select id="fColumn"></select>
            </div>
            <div class="field">
              <label>Qualidade</label>
              <select id="fQuality">
                <option value="APROVADO">Aprovado</option>
                <option value="MEDIA">Qualidade m√©dia</option>
                <option value="BAIXA">Qualidade baixa (risco)</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>N√∫meros vinculados (at√© 10) ‚Äî um por linha</label>
            <textarea id="fNumbers"></textarea>
            <div class="hint">Contagem: <span id="numbersCount" class="mono">0/10</span></div>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Disparo (data)</label>
              <input id="fDisparoDate" type="date" />
            </div>
            <div class="field">
              <label>Disparo (dia da semana)</label>
              <select id="fDisparoWeekday">
                <option value="">‚Äî</option>
                <option value="SEGUNDA">Segunda-feira</option>
                <option value="TERCA">Ter√ßa-feira</option>
                <option value="QUARTA">Quarta-feira</option>
                <option value="QUINTA">Quinta-feira</option>
                <option value="SEXTA">Sexta-feira</option>
                <option value="SABADO">S√°bado</option>
                <option value="DOMINGO">Domingo</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>Observa√ß√µes</label>
            <textarea id="fNotes"></textarea>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="field">
            <label>Data de cria√ß√£o</label>
            <input id="fCreatedAt" disabled />
          </div>

          <div class="field">
            <label>√öltima edi√ß√£o</label>
            <input id="fUpdatedAt" disabled />
          </div>

          <div class="field">
            <label>Marcar como ‚ÄúDisparado‚Äù</label>
            <div class="grid2">
              <label class="btn" style="justify-content:center; gap:10px; cursor:pointer;">
                <input type="checkbox" id="fIsDone" style="transform:scale(1.15); accent-color: var(--accent);" />
                <span>Disparado</span>
              </label>
              <input id="fDoneAt" type="date" />
            </div>
          </div>

          <div class="field">
            <label>Excluir BM</label>
            <button class="btn danger" id="btnDelete">Excluir</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="hint" id="editHint">Leitura</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnCancel">Fechar</button>
          <button class="btn primary" id="btnSave">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Connect modal -->
  <div class="modal-backdrop" id="settingsBackdrop" aria-hidden="true">
    <div class="modal sm" role="dialog" aria-modal="true">
      <div class="modal-header">
        <b>Conectar (online)</b>
        <button class="btn ghost" id="btnSettingsClose">‚úï</button>
      </div>
      <div class="modal-body one">
        <div class="field">
          <label>URL da API (Apps Script)</label>
          <input id="sApiUrl" placeholder="Cole a URL do Web App" />
          <div class="hint">Leitura: use #api=URL_DA_API | Edi√ß√£o: adicione &key=...&edit=1</div>
        </div>
        <div class="field">
          <label>Teste</label>
          <button class="btn" id="btnPing">Testar API</button>
          <div class="hint" id="pingResult">‚Äî</div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="hint">A chave fica no # (hash) e n√£o vai pro servidor.</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn danger" id="btnClearApi">Desconectar</button>
          <button class="btn" id="btnSettingsCancel">Fechar</button>
          <button class="btn primary" id="btnSettingsSave">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import program modal -->
  <div class="modal-backdrop" id="importProgBackdrop" aria-hidden="true">
    <div class="modal sm" role="dialog" aria-modal="true">
      <div class="modal-header">
        <b>Importar Programa√ß√£o (texto)</b>
        <button class="btn ghost" id="btnImportProgClose">‚úï</button>
      </div>
      <div class="modal-body one">
        <div class="field">
          <label>Cole o texto</label>
          <textarea id="importProgText" placeholder="MARCOS

5768 - 100 (09:30)
9106 - 100 (10:00)

SPORT

4630 - 120 (09:30)"></textarea>
          <div class="hint">Cria linhas na data + carteira selecionadas.</div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="hint">Importe e ajuste na tabela.</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnImportProgCancel">Cancelar</button>
          <button class="btn primary" id="btnImportProgRun">Importar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const CACHE_KEY = "bm_board_cache_v5";
    const SETTINGS_KEY = "bm_board_settings_v5";

    const BUCKETS = [
      { id:"GBR_CLT",  label:"GBR CLT" },
      { id:"GBR_NOVO", label:"GBR NOVO" },
      { id:"3P_CLT",   label:"3P CLT" },
      { id:"3P PORT",    label:"3P PORT" },
    ];
    const bucketLabel = (id) => (BUCKETS.find(b=>b.id===id)?.label || id);

    const COLUMNS = [
      { id:"standby",  name:"STAND BY" },
      { id:"numeros",  name:"N√öMEROS (at√© 10)" },
      { id:"cartao",   name:"CART√ÉO" },
      { id:"template", name:"TEMPLATE EM AN√ÅLISE" },
      { id:"disparos", name:"DISPAROS" }
    ];

    const QUALITY = {
      APROVADO: { label:"Aprovado", dot:"good" },
      MEDIA:    { label:"Qualidade m√©dia", dot:"mid" },
      BAIXA:    { label:"Qualidade baixa (risco)", dot:"bad" }
    };

    let settings = { apiUrl:"https://script.google.com/macros/s/AKfycbxyWYuCvc5P-LL3LzKOKiyJ6DeQEijd3R23fyIgQ-Q87wf4sylrF4z5sWhfJ6qYCfKH/exec", editKey:"", editorName:"", editMode:false };
    let state = { items: [], dispatches: [] };

    let currentId = null;
    let dirty = false;
    let syncing = false;
    let lastRemoteSig = "";
    let syncTimer = null;
    let pollTimer = null;

    const $ = (sel) => document.querySelector(sel);

    const pad2 = (n) => String(n).padStart(2,"0");
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function nowISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    function toBR(isoDate){
      if(!isoDate) return "‚Äî";
      const [y,m,d] = isoDate.split("-");
      return `${d}/${m}/${y}`;
    }
    function uuid(){
      return (crypto?.randomUUID?.() || ("id-"+Math.random().toString(16).slice(2) + "-" + Date.now()));
    }
    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 2600);
    }
    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizeNumbers(text){
      const arr = (text || "").split(/\r?\n/g).map(s=>s.trim()).filter(Boolean);
      const seen = new Set();
      const out = [];
      for(const n of arr){
        if(!seen.has(n)){ seen.add(n); out.push(n); }
      }
      return out.slice(0,10);
    }
    function getColumnName(id){ return (COLUMNS.find(c=>c.id===id)?.name) || id; }
    function qualityChip(q){
      const risk = (q === "BAIXA");
      return `
        <span class="chip">
          <span class="qdot ${q === "APROVADO" ? "good" : q === "BAIXA" ? "bad" : "mid"}"></span>
          <span>${risk ? '<span class="warn">RISCO</span>' : (q==="APROVADO"?"Aprovado":q==="MEDIA"?"Qualidade m√©dia":"Qualidade baixa")}</span>
        </span>
      `;
    }
    function scheduleLabel(item){
      if(item.disparoDate) return `üìÖ ${toBR(item.disparoDate)}`;
      if(item.disparoWeekday) return `üóìÔ∏è ${item.disparoWeekday}`;
      return "‚Äî";
    }
    function matchesFilters(item){
      const q = ($("#filterQuality").value || "").trim();
      if(q && item.quality !== q) return false;
      const s = ($("#search").value || "").trim().toLowerCase();
      if(!s) return true;
      const hay = [item.bmId, item.notes||"", (item.numbers||[]).join(" "), getColumnName(item.column), item.quality].join(" ").toLowerCase();
      return hay.includes(s);
    }

    function hasOnline(){ return !!settings.apiUrl; }
    function canEdit(){
      if(!settings.editMode) return false;        // read-only default
      if(!hasOnline()) return true;               // local edit only when edit=1
      return !!settings.editKey;                  // online edit needs key
    }
    function canSync(){ return hasOnline() && settings.editMode && !!settings.editKey; }

    function setAccessUI(){
      const dot = $("#syncDot");
      const text = $("#syncText");
      dot.className = "dot";
      if(canEdit()){
        dot.classList.add("good");
        text.textContent = hasOnline() ? "Edi√ß√£o (online)" : "Edi√ß√£o (local)";
      }else{
        dot.classList.add("mid");
        text.textContent = hasOnline() ? "Leitura (online)" : "Leitura (local)";
      }
      if(syncing) text.textContent = "Sincronizando‚Ä¶";
    }
    function updateEditUI(){
      setAccessUI();
      const editable = canEdit();
      $("#btnAdd").disabled = !editable;
      $("#btnImport").disabled = !editable;
      $("#btnReset").disabled = !editable;
      $("#btnAddLine").disabled = !editable;
      $("#btnImportText").disabled = !editable;
    }

    function saveCache(){ localStorage.setItem(CACHE_KEY, JSON.stringify(state)); }
    function loadCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && Array.isArray(parsed.items)) state.items = parsed.items;
          if(parsed && Array.isArray(parsed.dispatches)) state.dispatches = parsed.dispatches;
        }
      }catch(e){}
      if(!Array.isArray(state.items)) state.items = [];
      if(!Array.isArray(state.dispatches)) state.dispatches = [];
    }
    function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify({apiUrl:settings.apiUrl, editorName:settings.editorName})); }
    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          settings.apiUrl = (parsed.apiUrl || "").trim();
          settings.editorName = (parsed.editorName || "").trim();
        }
      }catch(e){}
    }

    function signatureOf(st){
      const str = JSON.stringify({
        items: (st.items||[]).map(i=>[i.id,i.bmId,i.column,i.quality,i.createdAt,i.updatedAt,i.disparoDate||"",i.disparoWeekday||"",i.isDone?1:0,i.doneAt||"", (i.numbers||[]).join(","), (i.notes||"")]),
        dispatches: (st.dispatches||[]).map(d=>[d.id,d.date,d.bucket,d.operator,d.code,d.qty,d.time])
      });
      let h=0; for(let k=0;k<str.length;k++) h=(h*31+str.charCodeAt(k))>>>0;
      return String(h);
    }
    function parseUpdatedAt(ts){
      const base = String(ts || "").slice(0,16);
      const m = base.match(/^(\d{4})-(\d{2})-(\d{2})\s(\d{2}):(\d{2})$/);
      if(!m) return 0;
      return new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], 0).getTime();
    }
    function mergeItemsById(localItems, remoteItems){
      const map = new Map();
      for(const it of (remoteItems||[])) map.set(it.id, it);
      for(const it of (localItems||[])){
        if(!map.has(it.id)) map.set(it.id, it);
        else{
          const r = map.get(it.id);
          map.set(it.id, parseUpdatedAt(it.updatedAt) >= parseUpdatedAt(r.updatedAt) ? it : r);
        }
      }
      return Array.from(map.values());
    }
    function mergeDispatches(localArr, remoteArr){
      const map = new Map();
      for(const d of (remoteArr||[])) map.set(d.id, d);
      for(const d of (localArr||[])) if(!map.has(d.id)) map.set(d.id, d);
      return Array.from(map.values());
    }

    async function fetchRemote(){
      const res = await fetch(settings.apiUrl, { method:"GET", cache:"no-store" });
      if(!res.ok) throw new Error("GET " + res.status);
      const data = await res.json();
      if(!data || !Array.isArray(data.items)) throw new Error("Formato inv√°lido");
      if(!Array.isArray(data.dispatches)) data.dispatches = [];
      return data;
    }
    async function pushRemote(){
      if(!canSync()) throw new Error("Sem permiss√£o");
      const url = settings.apiUrl + (settings.apiUrl.includes("?") ? "&" : "?") + "key=" + encodeURIComponent(settings.editKey);
      const res = await fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(state) });
      if(!res.ok) throw new Error("POST " + res.status);
      try{ await res.json(); }catch(e){}
    }
    function scheduleSync(){
      if(!canSync()) return;
      dirty = true;
      clearTimeout(syncTimer);
      syncTimer = setTimeout(async ()=>{
        try{
          syncing = true;
          updateEditUI();
          await pushRemote();
          syncing = false;
          dirty = false;
          lastRemoteSig = signatureOf(state);
          updateEditUI();
          toast("Sincronizado.");
        }catch(e){
          syncing = false;
          updateEditUI();
          toast("Erro ao sincronizar.");
          console.error(e);
        }
      }, 650);
    }
    async function startPolling(){
      clearInterval(pollTimer);
      if(!hasOnline()) return;
      pollTimer = setInterval(async ()=>{
        if(syncing || dirty) return;
        try{
          const remote = await fetchRemote();
          const sig = signatureOf(remote);
          if(!lastRemoteSig) lastRemoteSig = sig;
          if(sig !== lastRemoteSig){
            state.items = mergeItemsById(state.items, remote.items);
            state.dispatches = mergeDispatches(state.dispatches, remote.dispatches);
            saveCache();
            lastRemoteSig = signatureOf(state);
            render();
          }
        }catch(e){}
      }, 15000);
    }

    function withEditorSuffix(ts){
      if(!settings.editorName) return ts;
      return `${ts} ‚Äî ${settings.editorName}`;
    }
    function seedIfEmpty(){
      if(state.items.length) return;
      state.items = [{
        id: uuid(),
        bmId: "Exemplo: BM Planejamento",
        column: "standby",
        quality: "APROVADO",
        numbers: [],
        notes: "Abra o link de edi√ß√£o para alterar.",
        createdAt: todayISO(),
        updatedAt: withEditorSuffix(nowISO()),
        disparoDate: "",
        disparoWeekday: "",
        isDone: false,
        doneAt: ""
      }];
    }

    function parseHashSettings(){
      const hash = (location.hash || "").replace(/^#/, "").trim();
      if(!hash) return;
      const params = new URLSearchParams(hash);
  
      const key = params.get("key");
      const editor = params.get("editor");
      const edit = params.get("edit");
      if(api && api.trim()) settings.apiUrl = decodeURIComponent(api.trim());
      settings.editKey = key ? decodeURIComponent(key.trim()) : "";
      settings.editorName = editor ? decodeURIComponent(editor.trim()) : settings.editorName;
      settings.editMode = (String(edit||"").trim() === "1");
      saveSettings();
    }

    async function bootstrap(){
      loadSettings();
      parseHashSettings();
      loadCache();
      seedIfEmpty();

      $("#progDate").value = todayISO();
      $("#progBucket").value = "GBR_CLT";

      if(!hasOnline()){
        saveCache();
        updateEditUI();
        render();
        return;
      }

      try{
        const remote = await fetchRemote();
        state.items = mergeItemsById(state.items, remote.items);
        state.dispatches = mergeDispatches(state.dispatches, remote.dispatches);

        const remoteEmpty = (remote.items||[]).length===0 && (remote.dispatches||[]).length===0;
        if(remoteEmpty && canSync()){
          toast("Online vazio. Publicando dados locais‚Ä¶");
          syncing = true; updateEditUI();
          await pushRemote();
          syncing = false; updateEditUI();
        }

        saveCache();
        lastRemoteSig = signatureOf(state);
        updateEditUI();
        render();
        startPolling();
      }catch(e){
        console.error(e);
        updateEditUI();
        render();
      }
    }

    // Board render
    function renderBoard(){
      const board = $("#board");
      board.innerHTML = "";
      for(const col of COLUMNS){
        const items = state.items.filter(it=>it.column===col.id).filter(matchesFilters).sort((a,b)=>a.createdAt>b.createdAt?-1:1);
        const colEl = document.createElement("div");
        colEl.className = "col";
        colEl.innerHTML = `
          <div class="col-header">
            <b>${col.name}</b>
            <span class="badge">${items.length}</span>
          </div>
          <div class="dropzone" data-col="${col.id}"></div>
        `;
        const dz = colEl.querySelector(".dropzone");
        if(canEdit()){
          dz.addEventListener("dragover", e=>{e.preventDefault(); dz.classList.add("dragover");});
          dz.addEventListener("dragleave", ()=>dz.classList.remove("dragover"));
          dz.addEventListener("drop", e=>{
            e.preventDefault(); dz.classList.remove("dragover");
            const id = e.dataTransfer.getData("text/plain");
            moveItem(id, col.id);
          });
        }
        for(const it of items){
          const card = document.createElement("div");
          card.className = "card" + (canEdit() ? "" : " readonly");
          card.draggable = canEdit();
          const q = it.quality || "MEDIA";
          const nums = (it.numbers||[]).length;
          const sched = scheduleLabel(it);
          card.innerHTML = `
            <div class="card-top">
              <div style="min-width:0">
                <div class="bm-id">üè∑Ô∏è ${escapeHtml(it.bmId)}</div>
                <div class="meta">
                  <span class="chip"><strong>üìå ${toBR(it.createdAt)}</strong></span>
                  ${qualityChip(q)}
                  <span class="chip"><strong>‚òéÔ∏è ${nums}/10</strong></span>
                  <span class="chip"><strong>${sched}</strong></span>
                </div>
                ${it.notes ? `<div class="small" style="margin-top:8px">${escapeHtml(it.notes).slice(0,140)}${(it.notes.length>140?"‚Ä¶":"")}</div>` : `<div class="small" style="margin-top:8px">Sem observa√ß√µes.</div>`}
              </div>
              <div class="actions">
                <button class="iconbtn" data-action="edit">‚úèÔ∏è</button>
              </div>
            </div>
          `;
          if(canEdit()){
            card.addEventListener("dragstart", e=>{
              e.dataTransfer.setData("text/plain", it.id);
              e.dataTransfer.effectAllowed = "move";
            });
          }
          card.querySelector('[data-action="edit"]').addEventListener("click", ()=>openModal(it.id));
          dz.appendChild(card);
        }
        board.appendChild(colEl);
      }
    }

    // Agenda render (Programa√ß√£o priority)
    function renderAgendaProg(){
      const container = $("#agendaProg");
      container.innerHTML = "";
      const byDate = new Map();
      for(const d of (state.dispatches||[])){
        if(!d.date) continue;
        if(!byDate.has(d.date)) byDate.set(d.date, []);
        byDate.get(d.date).push(d);
      }
      const dates = Array.from(byDate.keys()).sort((a,b)=>a.localeCompare(b));
      if(!dates.length){
        container.innerHTML = `<div class="small muted">Sem programa√ß√£o cadastrada.</div>`;
        return;
      }
      for(const date of dates){
        const arr = byDate.get(date).slice();
        const total = arr.reduce((a,x)=>a+(Number(x.qty)||0),0);
        const header = document.createElement("div");
        header.className = "row";
        header.innerHTML = `
          <div class="row-left">
            <div><b>üìÖ ${toBR(date)}</b></div>
            <div class="small">Total: <b>${total}</b> disparos</div>
          </div>
          <div class="row-right">
            ${Array.from(new Set(arr.map(d=>d.bucket||"GBR_CLT"))).sort().map(b=>{
              const t = arr.filter(d=>(d.bucket||"GBR_CLT")===b).reduce((a,x)=>a+(Number(x.qty)||0),0);
              return `<span class="chip"><strong>${bucketLabel(b)}:</strong> ${t}</span>`;
            }).join("")}
          </div>
        `;
        container.appendChild(header);

        const buckets = Array.from(new Set(arr.map(d=>d.bucket||"GBR_CLT"))).sort();
        for(const b of buckets){
          const sub = arr.filter(d=>(d.bucket||"GBR_CLT")===b).slice().sort((x,y)=> (x.time||"").localeCompare(y.time||"") || String(x.code||"").localeCompare(String(y.code||"")));
          const block = document.createElement("div");
          block.className = "panel";
          block.style.margin = "10px 0 14px";
          block.innerHTML = `<h3>${bucketLabel(b)}</h3>`;
          const table = document.createElement("table");
          table.className = "table";
          table.innerHTML = `
            <thead>
              <tr>
                <th style="width:110px">Hora</th>
                <th style="width:140px">4 d√≠gitos</th>
                <th style="width:120px">Qtd</th>
                <th>Operador</th>
              </tr>
            </thead>
            <tbody>
              ${sub.map(d=>`
                <tr>
                  <td class="nowrap">${escapeHtml(d.time||"")}</td>
                  <td class="mono">${escapeHtml(d.code||"")}</td>
                  <td><b>${escapeHtml(String(d.qty||0))}</b></td>
                  <td>${escapeHtml((d.operator||"").toUpperCase())}</td>
                </tr>
              `).join("")}
            </tbody>
          `;
          block.appendChild(table);
          container.appendChild(block);
        }
      }
    }
    function renderAgendaBms(){
      const container = $("#agendaBms");
      container.innerHTML = "";
      const filtered = state.items.filter(matchesFilters);
      const upcoming = filtered.filter(i=>!i.isDone).filter(i=>i.disparoDate || i.disparoWeekday);
      if(!upcoming.length){
        container.innerHTML = `<div class="small muted">Sem agendamentos de BM.</div>`;
        return;
      }
      const groups = new Map();
      for(const it of upcoming){
        const key = it.disparoDate ? ("D:" + it.disparoDate) : ("W:" + it.disparoWeekday);
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it);
      }
      for(const [key, arr] of Array.from(groups.entries()).sort((a,b)=>a[0].localeCompare(b[0]))){
        const label = arr[0].disparoDate ? `üìÖ ${toBR(arr[0].disparoDate)}` : `üóìÔ∏è ${arr[0].disparoWeekday}`;
        const header = document.createElement("div");
        header.className = "row";
        header.innerHTML = `
          <div class="row-left">
            <div><b>${escapeHtml(label)}</b></div>
            <div class="small">${arr.length} BM(s)</div>
          </div>
          <div class="row-right"><span class="kbd">${canEdit() ? "Editar pelas BMs" : "Somente leitura"}</span></div>
        `;
        container.appendChild(header);
      }
    }
    function renderAgenda(){
      renderAgendaProg();
      renderAgendaBms();
    }

    // Programa√ß√£o
    function getProgDate(){ return $("#progDate").value || todayISO(); }
    function getProgBucket(){ return $("#progBucket").value || "GBR_CLT"; }
    function dispatchesFor(dateISO, bucketId){
      return (state.dispatches||[]).filter(d=>d.date===dateISO && (d.bucket||"GBR_CLT")===bucketId);
    }
    function computeTotals(dateISO, bucketId){
      const list = dispatchesFor(dateISO, bucketId);
      $("#progTotals").textContent = `${list.length} linhas ‚Ä¢ ${list.reduce((a,x)=>a+(Number(x.qty)||0),0)} disparos`;
    }
    function generateText(dateISO, bucketId){
      const list = dispatchesFor(dateISO, bucketId).slice();
      const ops = Array.from(new Set(list.map(d=>(d.operator||"").trim().toUpperCase()).filter(Boolean))).sort();
      const out = [];
      for(const op of ops){
        out.push(op); out.push("");
        const rows = list.filter(d=>(d.operator||"").trim().toUpperCase()===op).slice().sort((a,b)=> (a.time||"").localeCompare(b.time||"") || String(a.code||"").localeCompare(String(b.code||"")));
        for(const r of rows){
          const code = String(r.code||"").trim();
          if(!code) continue;
          out.push(`${code} - ${Number(r.qty||0)} (${String(r.time||"00:00")})`);
        }
        out.push("");
      }
      return out.join("\n").trim() + "\n";
    }
    function renderProg(){
      const dateISO = getProgDate();
      const bucketId = getProgBucket();
      const tbody = $("#progBody");
      tbody.innerHTML = "";
      const list = dispatchesFor(dateISO, bucketId).slice().sort((a,b)=> (a.operator||"").localeCompare(b.operator||"") || (a.time||"").localeCompare(b.time||""));
      const editable = canEdit();
      for(const d of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input class="cell-input" ${editable?"":"disabled"} value="${escapeHtml(d.operator||"")}" data-k="operator" data-id="${d.id}" placeholder="Ex: MARCOS" /></td>
          <td><input class="cell-input mini2" ${editable?"":"disabled"} value="${escapeHtml(d.code||"")}" data-k="code" data-id="${d.id}" placeholder="Ex: 5768" /></td>
          <td><input class="cell-input mini" ${editable?"":"disabled"} type="number" value="${escapeHtml(String(d.qty||""))}" data-k="qty" data-id="${d.id}" placeholder="Ex: 100" /></td>
          <td><input class="cell-input mini2" ${editable?"":"disabled"} type="time" value="${escapeHtml(d.time||"")}" data-k="time" data-id="${d.id}" /></td>
          <td class="nowrap"><button class="trash" ${editable?"":"disabled"} data-del="${d.id}">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll("input[data-k]").forEach(inp=>{
        inp.addEventListener("change", ()=>{
          if(!canEdit()){ toast("Somente leitura."); renderProg(); return; }
          const id = inp.getAttribute("data-id");
          const key = inp.getAttribute("data-k");
          let val = inp.value;
          if(key==="operator") val = String(val||"").trim().toUpperCase();
          if(key==="code") val = String(val||"").trim();
          if(key==="qty") val = Number(val||0);
          if(key==="time") val = String(val||"").trim();
          updateDispatch(id, { [key]: val });
        });
      });
      tbody.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(!canEdit()){ toast("Somente leitura."); return; }
          deleteDispatch(btn.getAttribute("data-del"));
        });
      });
      computeTotals(dateISO, bucketId);
      $("#progOutput").textContent = generateText(dateISO, bucketId);
    }
    function addDispatchRow(patch={}){
      if(!canEdit()){ toast("Somente leitura."); return; }
      const d = {
        id: uuid(),
        date: getProgDate(),
        bucket: getProgBucket(),
        operator: (patch.operator||"").toUpperCase(),
        code: patch.code||"",
        qty: Number(patch.qty||0),
        time: patch.time||""
      };
      state.dispatches.unshift(d);
      saveCache();
      renderProg();
      renderAgendaProg();
      scheduleSync();
    }
    function updateDispatch(id, patch){
      const idx = state.dispatches.findIndex(d=>d.id===id);
      if(idx<0) return;
      state.dispatches[idx] = { ...state.dispatches[idx], ...patch };
      saveCache();
      renderProg();
      renderAgendaProg();
      scheduleSync();
    }
    function deleteDispatch(id){
      state.dispatches = state.dispatches.filter(d=>d.id!==id);
      saveCache();
      renderProg();
      renderAgendaProg();
      scheduleSync();
    }
    function parseProgramText(text){
      const lines = String(text||"").split(/\r?\n/);
      let currentOp = "";
      let created = 0;
      for(const raw of lines){
        const line = raw.trim();
        if(!line) continue;
        const m = line.match(/^(.+?)\s*-\s*(\d+)\s*\((\d{2}:\d{2})\)\s*$/);
        if(m){
          const code = String(m[1]||"").trim();
          const qty = Number(m[2]||0);
          const time = String(m[3]||"").trim();
          if(!currentOp) currentOp = "OPERADOR";
          addDispatchRow({ operator: currentOp.toUpperCase(), code, qty, time });
          created += 1;
        }else{
          currentOp = line.toUpperCase();
        }
      }
      return created;
    }

    // Render all
    function render(){
      renderBoard();
      renderAgenda();
      renderProg();
      updateEditUI();
    }

    // CRUD items
    function createItem(payload){
      if(!canEdit()) return;
      const item = {
        id: uuid(),
        bmId: (payload.bmId||"").trim() || "BM sem nome",
        column: payload.column || "standby",
        quality: payload.quality || "MEDIA",
        numbers: payload.numbers || [],
        notes: payload.notes || "",
        createdAt: payload.createdAt || todayISO(),
        updatedAt: withEditorSuffix(nowISO()),
        disparoDate: payload.disparoDate || "",
        disparoWeekday: payload.disparoWeekday || "",
        isDone: !!payload.isDone,
        doneAt: payload.doneAt || ""
      };
      state.items.unshift(item);
      saveCache();
      render();
      scheduleSync();
    }
    function updateItem(id, patch){
      if(!canEdit()) return;
      const idx = state.items.findIndex(i=>i.id===id);
      if(idx<0) return;
      const before = state.items[idx];
      state.items[idx] = { ...before, ...patch, createdAt: before.createdAt || todayISO(), updatedAt: withEditorSuffix(nowISO()) };
      saveCache();
      render();
      scheduleSync();
    }
    function deleteItem(id){
      if(!canEdit()) return;
      state.items = state.items.filter(i=>i.id!==id);
      saveCache();
      render();
      scheduleSync();
    }
    function moveItem(id, colId){ updateItem(id, { column: colId }); }

    // BM modal
    function openModal(id){
      currentId = id;
      const isNew = !id;
      $("#modalTitle").textContent = isNew ? "Nova BM" : (canEdit() ? "Editar BM" : "Visualizar BM");
      $("#fColumn").innerHTML = COLUMNS.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");

      const item = isNew ? null : state.items.find(i=>i.id===id);
      $("#fBmId").value = item?.bmId || "";
      $("#fColumn").value = item?.column || "standby";
      $("#fQuality").value = item?.quality || "MEDIA";
      $("#fNumbers").value = (item?.numbers || []).join("\n");
      $("#fNotes").value = item?.notes || "";
      $("#fCreatedAt").value = item ? `${toBR(item.createdAt)} (${item.createdAt})` : `${toBR(todayISO())} (${todayISO()})`;
      $("#fUpdatedAt").value = item?.updatedAt || "‚Äî";
      $("#fDisparoDate").value = item?.disparoDate || "";
      $("#fDisparoWeekday").value = item?.disparoWeekday || "";
      $("#fIsDone").checked = !!item?.isDone;
      $("#fDoneAt").value = item?.doneAt || "";
      $("#numbersCount").textContent = `${normalizeNumbers($("#fNumbers").value).length}/10`;

      const lock = !canEdit();
      ["fBmId","fColumn","fQuality","fNumbers","fNotes","fDisparoDate","fDisparoWeekday","fIsDone","fDoneAt"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.disabled = lock;
      });
      $("#btnSave").disabled = lock;
      $("#btnDelete").style.display = (isNew || lock) ? "none" : "inline-flex";
      $("#editHint").textContent = lock ? "Leitura" : "Edi√ß√£o";

      $("#modalBackdrop").classList.add("open");
      $("#modalBackdrop").setAttribute("aria-hidden","false");
    }
    function closeModal(){
      $("#modalBackdrop").classList.remove("open");
      $("#modalBackdrop").setAttribute("aria-hidden","true");
      currentId = null;
    }

    // Connect modal
    function openSettings(){
      $("#sApiUrl").value = settings.apiUrl || "";
      $("#pingResult").textContent = "‚Äî";
      $("#settingsBackdrop").classList.add("open");
      $("#settingsBackdrop").setAttribute("aria-hidden","false");
    }
    function closeSettings(){
      $("#settingsBackdrop").classList.remove("open");
      $("#settingsBackdrop").setAttribute("aria-hidden","true");
    }

    // Import program modal
    function openImportProg(){
      $("#importProgText").value = "";
      $("#importProgBackdrop").classList.add("open");
      $("#importProgBackdrop").setAttribute("aria-hidden","false");
    }
    function closeImportProg(){
      $("#importProgBackdrop").classList.remove("open");
      $("#importProgBackdrop").setAttribute("aria-hidden","true");
    }

    // Events: board
    $("#btnAdd").addEventListener("click", ()=>openModal(null));
    $("#btnClose").addEventListener("click", closeModal);
    $("#btnCancel").addEventListener("click", closeModal);
    $("#modalBackdrop").addEventListener("click", (e)=>{ if(e.target === $("#modalBackdrop")) closeModal(); });

    $("#fNumbers").addEventListener("input", ()=>{ $("#numbersCount").textContent = `${normalizeNumbers($("#fNumbers").value).length}/10`; });

    $("#btnSave").addEventListener("click", ()=>{
      if(!canEdit()) return;
      const bmId = $("#fBmId").value.trim();
      if(!bmId){ toast("Informe a identifica√ß√£o."); return; }
      const numbers = normalizeNumbers($("#fNumbers").value);
      const patch = {
        bmId,
        column: $("#fColumn").value,
        quality: $("#fQuality").value,
        numbers,
        notes: ($("#fNotes").value||"").trim(),
        disparoDate: $("#fDisparoDate").value,
        disparoWeekday: $("#fDisparoWeekday").value,
        isDone: $("#fIsDone").checked,
        doneAt: $("#fDoneAt").value || ""
      };
      if(currentId){
        updateItem(currentId, patch);
      }else{
        createItem({ ...patch, createdAt: todayISO() });
      }
      closeModal();
    });

    $("#btnDelete").addEventListener("click", ()=>{
      if(!canEdit() || !currentId) return;
      if(!confirm("Excluir BM?")) return;
      deleteItem(currentId);
      closeModal();
    });

    // Search / filter
    $("#search").addEventListener("input", render);
    $("#filterQuality").addEventListener("change", render);

    // Tabs
    function setTab(which){
      const isBoard = which==="board";
      const isAgenda = which==="agenda";
      const isProg = which==="prog";
      $("#tabBoard").classList.toggle("active", isBoard);
      $("#tabAgenda").classList.toggle("active", isAgenda);
      $("#tabProg").classList.toggle("active", isProg);
      $("#viewBoard").style.display = isBoard ? "block" : "none";
      $("#viewAgenda").style.display = isAgenda ? "block" : "none";
      $("#viewProg").style.display = isProg ? "block" : "none";
      if(isAgenda) renderAgenda();
      if(isProg) renderProg();
    }
    $("#tabBoard").addEventListener("click", ()=>setTab("board"));
    $("#tabAgenda").addEventListener("click", ()=>setTab("agenda"));
    $("#tabProg").addEventListener("click", ()=>setTab("prog"));

    // Export / Import / Reset
    $("#btnExport").addEventListener("click", ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `organizador_bms_${todayISO()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Exportado.");
    });
    $("#btnImport").addEventListener("click", ()=>$("#importFile").click());
    $("#importFile").addEventListener("change", async (e)=>{
      if(!canEdit()){ toast("Somente leitura."); e.target.value=""; return; }
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        const text = await f.text();
        const parsed = JSON.parse(text);
        if(!parsed || !Array.isArray(parsed.items)) throw new Error("Formato inv√°lido.");
        if(!Array.isArray(parsed.dispatches)) parsed.dispatches = [];
        state.items = parsed.items;
        state.dispatches = parsed.dispatches;
        saveCache();
        render();
        scheduleSync();
        toast("Importado.");
      }catch(err){
        console.error(err);
        toast("Erro ao importar.");
      }finally{
        e.target.value="";
      }
    });
    $("#btnReset").addEventListener("click", ()=>{
      if(!canEdit()){ toast("Somente leitura."); return; }
      if(!confirm("Limpar tudo?")) return;
      state = { items: [], dispatches: [] };
      seedIfEmpty();
      saveCache();
      render();
      scheduleSync();
    });

    // Connect modal events
    $("#btnSettings").addEventListener("click", openSettings);
    $("#btnSettingsClose").addEventListener("click", closeSettings);
    $("#btnSettingsCancel").addEventListener("click", closeSettings);
    $("#settingsBackdrop").addEventListener("click", (e)=>{ if(e.target === $("#settingsBackdrop")) closeSettings(); });
    $("#btnSettingsSave").addEventListener("click", async ()=>{
      settings.apiUrl = ($("#sApiUrl").value||"").trim();
      saveSettings();
      closeSettings();
      toast("URL salva. Recarregando‚Ä¶");
      await bootstrap();
    });
    $("#btnClearApi").addEventListener("click", ()=>{
      settings.apiUrl = "";
      saveSettings();
      closeSettings();
      toast("Desconectado.");
      render();
    });
    $("#btnPing").addEventListener("click", async ()=>{
      const url = ($("#sApiUrl").value||"").trim();
      if(!url){ $("#pingResult").textContent = "Informe a URL."; return; }
      $("#pingResult").textContent = "Testando‚Ä¶";
      try{
        const res = await fetch(url, {method:"GET", cache:"no-store"});
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if(!data || !Array.isArray(data.items)) throw new Error("Formato inv√°lido");
        $("#pingResult").textContent = "OK";
      }catch(e){
        $("#pingResult").textContent = "Falhou";
      }
    });

    // Program events
    $("#progDate").addEventListener("change", renderProg);
    $("#progBucket").addEventListener("change", ()=>{ renderProg(); });
    $("#btnAddLine").addEventListener("click", ()=>addDispatchRow({operator:"",code:"",qty:0,time:""}));
    $("#btnGenerate").addEventListener("click", ()=>{ $("#progOutput").textContent = generateText(getProgDate(), getProgBucket()); toast("Texto gerado."); });
    $("#btnCopy").addEventListener("click", async ()=>{
      const text = $("#progOutput").textContent || "";
      if(!text.trim()){ toast("Nada para copiar."); return; }
      try{ await navigator.clipboard.writeText(text); toast("Copiado."); }
      catch(e){
        const ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove(); toast("Copiado.");
      }
    });
    $("#btnImportText").addEventListener("click", openImportProg);
    $("#btnImportProgClose").addEventListener("click", closeImportProg);
    $("#btnImportProgCancel").addEventListener("click", closeImportProg);
    $("#importProgBackdrop").addEventListener("click", (e)=>{ if(e.target === $("#importProgBackdrop")) closeImportProg(); });
    $("#btnImportProgRun").addEventListener("click", ()=>{
      if(!canEdit()){ toast("Somente leitura."); return; }
      const txt = $("#importProgText").value || "";
      const count = parseProgramText(txt);
      closeImportProg();
      toast(`Importado: ${count} linha(s).`);
      renderProg();
      renderAgendaProg();
    });

    // init
    bootstrap();
  </script>
</body>
</html>
